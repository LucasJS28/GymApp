<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymApp Pro - Gesti√≥n Integral de Gimnasio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* =================================================================
           == üé® PALETA DE COLORES Y VARIABLES GLOBALES DE DISE√ëO üé® ==
           ================================================================= */
        :root {
            --primary-color: #7C5DFF; --primary-hover: #6B4DE6; --primary-light: rgba(124, 93, 255, 0.1);
            --secondary-color: #9277FF; --success-color: #34D399; --info-color: #00D4C8;
            --danger-color: #EF4444; --warning-color: #F59E0B;
            
            --sidebar-width: 260px;
            --mobile-header-height: 60px;
            --font-family-sans-serif: 'Poppins', sans-serif;
            --border-radius: 1rem;
            --transition-speed: 0.3s;
            
            --light-bg: #F8F8FB; --light-content-bg: #FFFFFF; --light-text-color: #0C0E16;
            --light-text-muted: #888EB0; --light-border-color: #DFE3FA;
            --light-shadow: 0 10px 20px -5px rgba(72, 84, 159, 0.1);

            --dark-bg: #141625; --dark-content-bg: #1E2139; --dark-text-color: #FFFFFF;
            --dark-text-muted: #DFE3FA; --dark-border-color: #252945;
            --dark-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2);
        }

        /* =================================================================
           == üñåÔ∏è ESTILOS BASE Y MODO OSCURO üñåÔ∏è ==
           ================================================================= */
        html { scroll-behavior: smooth; }
        body {
            background-color: var(--light-bg); color: var(--light-text-color);
            font-family: var(--font-family-sans-serif);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text-color);
            --bs-body-color: var(--dark-text-color); --bs-body-bg: var(--dark-bg);
            --bs-tertiary-bg: var(--dark-content-bg);
        }
        .card {
            background-color: var(--light-content-bg); border: 1px solid var(--light-border-color);
            border-radius: var(--border-radius); box-shadow: var(--light-shadow);
            transition: all var(--transition-speed);
        }
        .modal-content, .list-group-item {
            background-color: var(--light-content-bg); border: 1px solid var(--light-border-color);
            transition: all var(--transition-speed);
        }
        .modal-content { border-radius: var(--border-radius); }


        .dark-mode .card, .dark-mode .modal-content, .dark-mode .list-group-item {
            background-color: var(--dark-content-bg); border-color: var(--dark-border-color);
            box-shadow: var(--dark-shadow);
        }
        .dark-mode .list-group-item-action:hover {
            background-color: #252945;
            color: var(--dark-text-color);
        }
        .text-muted { color: var(--light-text-muted) !important; }
        .dark-mode .text-muted { color: var(--dark-text-muted) !important; }
        .dark-mode .form-control, .dark-mode .form-select {
            background-color: #252945; color: var(--dark-text-color); border-color: #252945;
        }
        .dark-mode .form-control:focus, .dark-mode .form-select:focus {
            background-color: var(--dark-content-bg); border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(124, 93, 255, 0.25);
        }
        .dark-mode .btn-close { filter: invert(1) brightness(2); }
        .dark-mode .table { --bs-table-color: var(--dark-text-color); --bs-table-border-color: var(--dark-border-color); --bs-table-striped-bg: #252945; }
        .dark-mode .table-hover>tbody>tr:hover>* {
            --bs-table-accent-bg: #2a2e4c;
            --bs-table-hover-color: var(--dark-text-color);
        }
        .dark-mode .dropdown-menu { --bs-dropdown-bg: var(--dark-content-bg); --bs-dropdown-border-color: var(--dark-border-color); --bs-dropdown-link-color: var(--dark-text-color); --bs-dropdown-link-hover-bg: #252945; }
        .main-container { display: flex; }
        .content {
            margin-left: var(--sidebar-width); padding: 2.5rem;
            width: calc(100% - var(--sidebar-width));
            transition: margin-left var(--transition-speed) ease-in-out;
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .card-header {
            background-color: transparent;
            border-bottom: 1px solid var(--light-border-color);
            padding: 1.25rem 1.5rem;
        }
        .dark-mode .card-header {
            border-bottom: 1px solid var(--dark-border-color);
        }

        /* [NUEVO] ESTILOS PARA TABS EN MODO OSCURO */
        body.dark-mode .nav-tabs {
            border-bottom-color: var(--dark-border-color);
        }
        body.dark-mode .nav-tabs .nav-link {
            color: var(--dark-text-muted);
            border-color: transparent;
            border-bottom-color: var(--dark-border-color);
        }
        body.dark-mode .nav-tabs .nav-link:hover {
            border-color: var(--dark-border-color);
            color: var(--dark-text-color);
        }
        body.dark-mode .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: var(--dark-content-bg);
            border-color: var(--dark-border-color);
            border-bottom-color: var(--primary-color);
        }


        /* =================================================================
           == üö™ ESTILOS PANTALLA DE LOGIN üö™ ==
           ================================================================= */
        #login-section {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; width: 100%;
            background-color: var(--light-bg);
            background-image:
                radial-gradient(circle at 1% 1%, var(--primary-light) 0.5px, transparent 0),
                radial-gradient(circle at 99% 99%, var(--primary-light) 0.5px, transparent 0);
            background-size: 50px 50px;
            transition: opacity 0.5s;
        }
        .dark-mode #login-section { background-color: var(--dark-bg); }
        .login-container {
            background: var(--light-content-bg); padding: 50px; border-radius: 20px;
            box-shadow: var(--light-shadow); width: 100%; max-width: 480px;
            border: 1px solid var(--light-border-color);
            transform: scale(1); transition: all .3s;
        }
        .dark-mode .login-container {
            background: rgba(30, 33, 57, 0.85);
            border: 1px solid var(--dark-border-color);
            backdrop-filter: blur(10px);
        }
        .login-container h1 { color: var(--primary-color); font-weight: 700; }
        .login-container .btn {
            padding: 12px; font-size: 1.1rem; border-radius: 12px;
            transition: all 0.2s ease-in-out;
        }
        .login-container .btn:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .btn { transition: all 0.2s ease-in-out; border-radius: 0.75rem;}
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(124, 93, 255, 0.3);
        }
        .btn-info { background-color: var(--info-color); border-color: var(--info-color); }
        .btn-info:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-success { background-color: var(--success-color); border-color: var(--success-color); }
        .btn-success:hover { opacity: 0.9; transform: translateY(-2px); }

        /* =================================================================
           == üß≠ SIDEBAR Y NAVEGACI√ìN üß≠ ==
           ================================================================= */
        .sidebar {
            width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0;
            background: var(--light-content-bg); color: var(--light-text-color);
            transition: transform var(--transition-speed) ease-in-out, background-color var(--transition-speed), color var(--transition-speed);
            z-index: 1002; box-shadow: 5px 0 25px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
            border-right: 1px solid var(--light-border-color);
            overflow: hidden; 
        }
        .sidebar-header {
            padding: 1.5rem;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; 
        }
        .sidebar-header h4 { font-weight: 700; margin-bottom: 0; color: var(--light-text-color); }
        .sidebar-header .fa-dumbbell { color: var(--primary-color); }
        
        .user-profile-summary { 
            padding: 2rem 1.5rem; 
            text-align: center;
            flex-shrink: 0;
        }
        .profile-avatar {
            width: 100px; height: 100px; margin: 0 auto 1rem; border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; font-size: 2.5rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
            border: 4px solid var(--light-border-color);
        }
        #profile-name { font-weight: 600; margin-bottom: 0.25rem; color: var(--light-text-color); font-size: 1.1rem; }
        #profile-role { color: var(--light-text-muted); font-size: 0.9rem; }
        
        .sidebar-nav-container {
            flex-grow: 1; 
            overflow-y: auto; 
            overflow-x: hidden; 
            padding-top: 1rem;
            padding-bottom: 1rem;
            position: relative;
        }

        .sidebar-nav-container::-webkit-scrollbar { width: 8px; }
        .sidebar-nav-container::-webkit-scrollbar-track { background: transparent; }
        .sidebar-nav-container::-webkit-scrollbar-thumb {
            background-color: var(--light-border-color);
            border-radius: 10px;
            border: 2px solid var(--light-content-bg);
        }
        .dark-mode .sidebar-nav-container::-webkit-scrollbar-thumb {
            background-color: #252945;
            border-color: var(--dark-bg);
        }

        .sidebar .nav-link {
            color: var(--light-text-muted); font-size: 1rem; padding: 14px 25px;
            border-radius: 0 50px 50px 0; margin: 6px 15px 6px 0;
            transition: all 0.2s ease-in-out; display: flex; align-items: center;
            border-left: 4px solid transparent;
            cursor: pointer;
        }
        .sidebar .nav-link .fa-fw { width: 1.5em; opacity: 0.8; }
        .sidebar .nav-link:hover {
            color: var(--primary-color);
            background-color: var(--primary-light);
        }
        .sidebar .nav-link.active {
            color: #ffffff;
            background-color: var(--primary-color);
            border-left: 4px solid var(--secondary-color);
        }

        .sidebar-footer { 
            padding: 1.5rem; 
            border-top: 1px solid var(--light-border-color); 
            flex-shrink: 0;
        }
        .theme-switch-wrapper .form-check-label { color: var(--light-text-muted); }

        .dark-mode .sidebar {
            background: var(--dark-content-bg);
            color: white;
            border-right: 1px solid var(--dark-border-color);
        }
        .dark-mode .sidebar-header { border-bottom: 1px solid #252945; }
        .dark-mode .sidebar-header h4 { color: #fff; }
        .dark-mode .profile-avatar { border: 4px solid #252945; }
        .dark-mode #profile-name { color: #fff; }
        .dark-mode #profile-role { color: #DFE3FA; }
        .dark-mode .sidebar .nav-link { color: #DFE3FA; }
        .dark-mode .sidebar .nav-link:hover {
            color: #ffffff;
            background-color: rgba(124, 93, 255, 0.2);
        }
        .dark-mode .sidebar .nav-link.active {
            color: #ffffff;
            background-color: var(--primary-color);
            border-left: 4px solid var(--secondary-color);
        }
        .dark-mode .sidebar-footer { border-top: 1px solid #252945; }
        .dark-mode .theme-switch-wrapper .form-check-label { color: #DFE3FA; }
        
        /* =================================================================
           == üåü INDICADOR DE SCROLL SIDEBAR üåü ==
           ================================================================= */
        @keyframes bounce-arrow {
            0%, 20%, 50%, 80%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            40% {
                transform: translateX(-50%) translateY(8px);
            }
            60% {
                transform: translateX(-50%) translateY(4px);
            }
        }

        .sidebar-nav-container::after {
            content: '\f078'; /* Icono de chevron hacia abajo */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: #FFFFFF; /* Flecha blanca para que contraste con el fondo */
            box-shadow: 0 4px 15px rgba(124, 93, 255, 0.4); /* Sombra m√°s notoria */

            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;

            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%); /* Centrado horizontal inicial */

            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }

        .dark-mode .sidebar-nav-container::after {
            background-color: rgba(124, 93, 255, 0.2);
            color: var(--primary-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid var(--dark-border-color);
        }

        .sidebar-nav-container.is-scrollable::after {
            opacity: var(--scroll-indicator-opacity, 1);
            visibility: visible;
            animation: bounce-arrow 2.5s infinite ease-in-out;
        }
        
        /* =================================================================
           == üì± CABECERA M√ìVIL Y OVERLAY üì± ==
           ================================================================= */
        .mobile-header {
            display: none; align-items: center; justify-content: space-between;
            background-color: var(--light-content-bg); color: var(--light-text-color); height: var(--mobile-header-height);
            padding: 0 1rem; position: fixed; top: 0; left: 0; right: 0; z-index: 1001;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-bottom: 1px solid var(--light-border-color);
        }
        .dark-mode .mobile-header { background-color: #1E2139; color: white; border-bottom-color: var(--dark-border-color); }
        .hamburger-btn { background: transparent; border: none; color: var(--light-text-color); font-size: 1.5rem; }
        .dark-mode .hamburger-btn { color: white; }
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1001;
            opacity: 0; visibility: hidden; transition: opacity var(--transition-speed) ease, visibility 0s var(--transition-speed);
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; transition: opacity var(--transition-speed) ease, visibility 0s; }
        body.sidebar-is-open { overflow: hidden; }

        /* =================================================================
           == üß© [MEJORADO] ESTILOS DE COMPONENTES ESPEC√çFICOS üß© ==
           ================================================================= */
        .stat-card { transition: transform 0.2s, box-shadow 0.2s; border: none; border-left: 5px solid var(--primary-color); }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 12px 25px -8px rgba(72, 84, 159, 0.2); }
        .dark-mode .stat-card:hover { box-shadow: 0 12px 25px -8px rgba(0, 0, 0, 0.3); }
        .stat-card .card-body { position: relative; overflow: hidden; }
        .stat-card i.fas { font-size: 3.5rem; opacity: 0.08; position: absolute; right: 1rem; bottom: -0.5rem; transition: all .3s; }
        .stat-card:hover i.fas { transform: scale(1.1) rotate(-5deg); opacity: 0.1; }
        
        #routine-cards-container .routine-day-card.is-today {
            transform: scale(1.03);
            box-shadow: 0 0 0 3px var(--primary-color), var(--light-shadow); 
            border-color: var(--primary-color) !important;
        }
        .dark-mode #routine-cards-container .routine-day-card.is-today {
            box-shadow: 0 0 0 3px var(--primary-color), var(--dark-shadow); 
        }

        .routine-day-card { border-left-width: 5px; }
        .routine-day-card.is-today-completed { border-left-color: var(--success-color); }
        .routine-day-card.is-rest-day { border-left-color: var(--light-text-muted); }
        
        /* [NUEVO] ESTILOS PARA LA SECCI√ìN DE PLANES */
        .plan-card {
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column; height: 100%;
            position: relative; overflow: hidden;
        }
        .plan-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(124, 93, 255, 0.2);
        }
        .plan-card .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; border-bottom: 0; text-align: center;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            padding: 1.5rem 1rem;
        }
        .plan-card .card-body {
            display: flex; flex-direction: column; flex-grow: 1; text-align: center;
        }
        .plan-card .price { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); }
        .dark-mode .plan-card .price { color: var(--secondary-color); }
        .plan-card .duration { font-size: 1rem; font-weight: 400; opacity: 0.7; }
        .plan-card .benefits-list {
            list-style: none; padding: 0; margin: 1.5rem 0; text-align: left; flex-grow: 1;
        }
        .plan-card .benefits-list li {
            padding-left: 1.75rem; position: relative; margin-bottom: 0.75rem;
        }
        .plan-card .benefits-list li::before {
            content: '\f058'; /* Icono check */
            font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; left: 0; top: 2px; color: var(--success-color);
        }
        .plan-card.is-recommended {
            border: 2px solid var(--primary-color);
            transform: scale(1.03);
        }
        .plan-card.is-recommended::before {
            content: 'RECOMENDADO';
            position: absolute; top: 18px; right: -38px;
            background-color: var(--warning-color); color: white;
            font-size: 0.75rem; font-weight: 700; padding: 5px 40px;
            transform: rotate(45deg);
        }
        
        .student-plan-display {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; padding: 2rem; border-radius: var(--border-radius);
        }
        
        .search-input-group { position: relative; }
        .search-input-group .fa-search { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--light-text-muted); }
        .dark-mode .search-input-group .fa-search { color: var(--dark-text-muted); }
        .search-input-group .form-control { padding-left: 40px; border-radius: 50px; }

        .goal-card {
            background: var(--primary-light);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: flex; flex-direction: column; height: 100%;
        }
        .dark-mode .goal-card {
            background-color: var(--dark-content-bg);
            border: 1px solid var(--dark-border-color);
        }
        .goal-card-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .goal-card-icon {
            font-size: 1.5rem; color: var(--primary-color); background-color: white;
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .dark-mode .goal-card-icon { background-color: #252945; }
        .goal-card .progress { height: 1rem; border-radius: 1rem; }

        .recommendation-card .icon-circle {
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; flex-shrink: 0;
        }
        .recommendation-card ul { list-style: none; padding-left: 0; }
        .recommendation-card ul li { padding-left: 1.75rem; position: relative; margin-bottom: 0.5rem; }
        .recommendation-card ul li::before {
            content: '\f058'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; left: 0; top: 2px; color: var(--success-color);
        }

        /* [NUEVO Y MEJORADO] ESTILOS PARA GESTI√ìN DE INSTALACIONES */
        #facilities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        .equipment-card {
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        .equipment-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--light-shadow);
        }
        dark-mode .equipment-card:hover { box-shadow: var(--dark-shadow); }
        .equipment-card .card-header {
            display: flex; justify-content: space-between; align-items: center;
            background-color: transparent !important;
            padding-bottom: 0.5rem;
        }
        .equipment-card .card-title { margin-bottom: 0; font-weight: 600; }
        .equipment-card .type-icon { font-size: 1.5rem; opacity: 0.5; }

        .equipment-card .details-list { list-style: none; padding: 0; margin: 0; }
        .equipment-card .details-list li {
            display: flex; align-items: center; padding: 0.5rem 0;
            border-bottom: 1px solid var(--light-border-color);
            font-size: 0.9rem;
        }
        .dark-mode .equipment-card .details-list li { border-bottom-color: var(--dark-border-color); }
        .equipment-card .details-list li:last-child { border-bottom: none; }
        .equipment-card .details-list .icon { width: 30px; text-align: center; color: var(--light-text-muted); }
        .dark-mode .equipment-card .details-list .icon { color: var(--dark-text-muted); }
        .equipment-card .details-list strong { margin-right: auto; }
        
        .status-operativo { border-left: 4px solid var(--success-color); }
        .status-mantenimiento { border-left: 4px solid var(--warning-color); }
        .status-averiado { border-left: 4px solid var(--danger-color); }
        
        /* =================================================================
           == üèãÔ∏è BIBLIOTECA DE EJERCICIOS MEJORADA üèãÔ∏è ==
           ================================================================= */
        #exercise-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        #exercise-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .exercise-card {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .exercise-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--light-shadow);
        }
        .dark-mode .exercise-card:hover {
            box-shadow: var(--dark-shadow);
        }
        .exercise-card .card-footer {
            background-color: transparent;
            border-top: 1px solid var(--light-border-color);
        }
        .dark-mode .exercise-card .card-footer {
            border-top-color: var(--dark-border-color);
        }

        .exercise-video-wrapper {
            position: relative;
            padding-bottom: 56.25%; 
            height: 0;
            overflow: hidden;
            border-radius: calc(var(--border-radius) - 1px);
            background-color: #000;
        }
        .exercise-video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #mainModalBody .list-group-item {
            border-left: 0;
            border-right: 0;
        }
        #mainModalBody .list-group-item:first-child { border-top-left-radius: 0; border-top-right-radius: 0; }
        
        #mainModalBody ol { padding-left: 1.2rem; }
        #mainModalBody ol li { margin-bottom: 0.5rem; }

        /* =================================================================
           == üìÖ ESTILOS DE FULLCALENDAR (REVISADOS Y MEJORADOS) üìÖ ==
           ================================================================= */
        .fc { font-size: 1rem; }
        .fc .fc-toolbar.fc-header-toolbar { margin-bottom: 1.5rem; }
        .fc .fc-daygrid-day.fc-day-today { background-color: var(--primary-light); }
        .fc .fc-button, .fc .fc-button-primary {
            background-color: var(--primary-color); border-color: var(--primary-color);
            text-transform: capitalize; transition: all .2s;
        }
        .fc .fc-button-primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }
        .fc-event { border-radius: 5px; padding: 2px 4px; border: none !important; font-size: 0.8rem; }
        
        .dark-mode .fc-toolbar-title { color: var(--dark-text-color); }
        .dark-mode .fc .fc-col-header-cell-cushion { color: var(--dark-text-muted); font-weight: 500;}
        .dark-mode .fc-daygrid-day-number { color: var(--dark-text-muted); }
        .dark-mode .fc-theme-standard td, .dark-mode .fc-theme-standard th { border-color: var(--dark-border-color); }
        .dark-mode .fc .fc-daygrid-day.fc-day-today { background-color: rgba(124, 93, 255, 0.2); }
        
        .dark-mode .fc .fc-button {
            background-color: var(--dark-content-bg);
            border: 1px solid var(--dark-border-color);
            color: var(--dark-text-color);
        }
        .dark-mode .fc .fc-button:hover { background-color: #252945; }
        .dark-mode .fc .fc-button-primary:disabled { background-color: #252945; }
        .dark-mode .fc .fc-button-primary:not(:disabled).fc-button-active, 
        .dark-mode .fc .fc-button-primary:not(:disabled):active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            box-shadow: none;
        }

        .dark-mode .fc-event { color: white; }
        .dark-mode .fc-daygrid-event:hover, .dark-mode .fc-list-event:hover { background-color: rgba(255, 255, 255, 0.1); }
        
        .dark-mode .fc-popover {
            background-color: var(--dark-content-bg);
            border-color: var(--dark-border-color);
            box-shadow: var(--dark-shadow);
        }
        .dark-mode .fc-popover-header {
            background-color: #252945;
            color: var(--dark-text-color);
        }
        
        .dark-mode .fc-list-day-cushion { background-color: #252945; }
        .dark-mode .fc-list-event-dot { border-color: var(--primary-color); }
        .dark-mode .fc-list-table { color: var(--dark-text-muted); }
        .dark-mode .fc-list-event:hover td { background-color: rgba(37, 41, 69, 0.5); }


        /* =================================================================
           == üî• ESTILOS DE SWEETALERT2 üî• ==
           ================================================================= */
        body.dark-mode .swal2-popup { background: var(--dark-content-bg); color: var(--dark-text-color); }
        body.dark-mode .swal2-title { color: var(--dark-text-color); }
        body.dark-mode .swal2-html-container { color: var(--dark-text-muted); }
        body.dark-mode .swal2-confirm { background-color: var(--primary-color) !important; }
        body.dark-mode .swal2-cancel { background-color: var(--secondary-color) !important; }
        body.dark-mode .swal2-input, .dark-mode .swal2-textarea, .dark-mode .swal2-select { background-color: #252945 !important; color: var(--dark-text-color) !important; border-color: var(--dark-border-color) !important; }

        /* =================================================================
           == ‚öôÔ∏è LOADER INICIAL ‚öôÔ∏è ==
           ================================================================= */
        #app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--light-bg); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-out;
        }
        .dark-mode #app-loader { background: var(--dark-bg); }
        .spinner {
            width: 56px; height: 56px;
            border-radius: 50%;
            padding: 1.1px;
            background: conic-gradient(#0000 10%, var(--primary-color)) content-box;
            -webkit-mask:
                repeating-conic-gradient(#0000 0deg, #000 1deg 20deg, #0000 21deg 36deg),
                radial-gradient(farthest-side, #0000 calc(100% - 9px), #000 calc(100% - 8px));
            -webkit-mask-composite: destination-in;
            mask-composite: intersect;
            animation: spin 1s infinite steps(10);
        }
        @keyframes spin { to { transform: rotate(1turn) } }
        
        /* =================================================================
           == üí¨ ESTILOS DEL CHAT FLOTANTE üí¨ ==
           ================================================================= */
        #chat-bubble {
            position: fixed; bottom: 25px; right: 25px;
            width: 60px; height: 60px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.8rem;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1050;
            transform: scale(0);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            animation: bubble-intro 0.5s 1s forwards;
        }
        @keyframes bubble-intro {
            to { transform: scale(1); opacity: 1; }
        }
        #chat-bubble:hover { transform: scale(1.1); }
        #chat-bubble .notification-dot {
            position: absolute; top: 5px; right: 5px;
            width: 12px; height: 12px;
            background-color: var(--danger-color);
            border-radius: 50%; border: 2px solid var(--light-content-bg);
            display: none;
        }
        .dark-mode #chat-bubble .notification-dot { border-color: var(--dark-content-bg); }

        #chat-window {
            position: fixed; bottom: 100px; right: 25px;
            width: 420px; height: 65vh; max-height: 700px; min-height: 400px;
            background-color: var(--light-content-bg);
            border: 1px solid var(--light-border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--light-shadow);
            display: flex; flex-direction: column;
            overflow: hidden;
            z-index: 1049;
            transform: translateY(20px) scale(0.95); opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            visibility: hidden;
        }
        .dark-mode #chat-window { background-color: var(--dark-content-bg); border-color: var(--dark-border-color); box-shadow: var(--dark-shadow); }
        #chat-window.open {
            transform: translateY(0) scale(1); opacity: 1; visibility: visible;
        }
        .chat-main-container { display: flex; height: 100%; position: relative; overflow-x: hidden; }
        .chat-sidebar {
            width: 100%;
            border-right: 1px solid var(--light-border-color);
            background-color: var(--light-bg);
            overflow-y: auto;
            transition: transform 0.3s ease;
            position: absolute; top: 0; left: 0; height: 100%;
        }
        .dark-mode .chat-sidebar { border-right-color: var(--dark-border-color); background-color: var(--dark-bg); }
        .chat-contact-list { padding: 0.5rem 0; margin: 0; list-style: none; }
        .chat-contact-item {
            padding: 0.75rem; cursor: pointer;
            transition: background-color var(--transition-speed);
            display: flex; align-items: center; gap: 0.75rem;
            border-right: 4px solid transparent;
        }
        .chat-contact-item:hover { background-color: var(--primary-light); }
        .chat-contact-item.active {
            background-color: var(--light-content-bg);
            border-right-color: var(--primary-color);
        }
        .dark-mode .chat-contact-item.active { background-color: var(--dark-content-bg); }
        .contact-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; font-weight: 500; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .contact-info { overflow: hidden; }
        .contact-info .fw-bold { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .chat-area { 
            flex-grow: 1; display: flex; flex-direction: column; width: 100%; 
            position: absolute; top: 0; left: 0; height: 100%;
            transform: translateX(100%); transition: transform 0.3s ease;
        }
        #chat-window.mobile-chat-view .chat-sidebar { transform: translateX(-100%); }
        #chat-window.mobile-chat-view .chat-area { transform: translateX(0); }
        .chat-header {
            padding: 0.75rem 1.5rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-header .chat-back-btn { display: none; background: none; border: none; font-size: 1.2rem; margin-right: 1rem; color: var(--light-text-color); }
        .dark-mode .chat-header .chat-back-btn { color: var(--dark-text-color); }
        .chat-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; }
        .chat-message { display: flex; margin-bottom: 1rem; max-width: 90%; }
        .chat-message p {
            padding: 0.75rem 1rem; border-radius: 1.25rem;
            line-height: 1.4; word-wrap: break-word;
        }
        .message-sent { margin-left: auto; flex-direction: row-reverse; }
        .message-sent p {
            background-color: var(--primary-color); color: white;
            border-bottom-right-radius: 0.25rem;
        }
        .message-received { margin-right: auto; }
        .message-received p {
            background-color: #E5E7EB;
            border-bottom-left-radius: 0.25rem;
        }
        .dark-mode .message-received p { background-color: #252945; }
        
        .message-typing { font-style: italic; color: var(--light-text-muted); }
        .typing-indicator span {
            display: inline-block; width: 8px; height: 8px; margin: 0 1px;
            background-color: var(--light-text-muted); border-radius: 50%;
            animation: typing 1.4s infinite both;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        .chat-input {
            padding: 1rem 1.5rem; border-top: 1px solid var(--light-border-color);
        }
        .dark-mode .chat-input { border-top-color: var(--dark-border-color); }
        .chat-input .form-control { border-radius: 50px; background-color: var(--light-bg); border-color: var(--light-border-color); }
        .dark-mode .chat-input .form-control { background-color: var(--dark-bg); border-color: var(--dark-border-color); }

        /* =================================================================
           == ‚ú® MEJORAS VISUALES GENERALES ‚ú® ==
           ================================================================= */
        .page-header {
            margin-bottom: 2.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--light-border-color);
        }
        .dark-mode .page-header {
            border-bottom-color: var(--dark-border-color);
        }

        .card:hover {
            box-shadow: 0 15px 30px -10px rgba(72, 84, 159, 0.15);
        }
        .dark-mode .card:hover {
            box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.25);
        }
        
        .form-control, .form-select {
            transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
        }
        
        .table {
            border-collapse: separate;
            border-spacing: 0;
        }
        .table th, .table td {
            padding: 1rem;
            vertical-align: middle;
        }
        .table tbody tr {
            border-bottom: 1px solid var(--light-border-color);
        }
        .dark-mode .table tbody tr {
            border-bottom: 1px solid var(--dark-border-color);
        }
        .table tbody tr:last-child {
            border-bottom: none;
        }

        /* [NUEVO] Estilos para el dashboard del profesor */
        .prof-dash-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            position: relative;
            overflow: hidden;
        }
        .prof-dash-card .icon-bg {
            position: absolute;
            right: -20px;
            bottom: -20px;
            font-size: 6rem;
            opacity: 0.15;
            transform: rotate(-15deg);
        }

        /* [NUEVO] Estilos para gestionar alumnos */
        #students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .student-card {
            transition: all 0.2s ease-in-out;
        }
        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--light-shadow);
        }
        .dark-mode .student-card:hover {
            box-shadow: var(--dark-shadow);
        }
        .student-card-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-light);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        .dark-mode .student-card-avatar {
            background-color: #252945;
        }

        /* [NUEVO] Estilos para la secci√≥n de evaluaciones del profesor */
        .evaluation-history-card {
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1rem;
        }
        .evaluation-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            text-align: center;
        }
        .metric-item strong {
            font-size: 1.25rem;
            display: block;
        }
        .metric-item span {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--light-text-muted);
        }
        .dark-mode .metric-item span {
            color: var(--dark-text-muted);
        }


        /* =================================================================
           == üìê MEDIA QUERIES RESPONSIVE üìê ==
           ================================================================= */
        @media (max-width: 992px) {
            .sidebar { transform: translateX(calc(-1 * var(--sidebar-width))); z-index: 1002; }
            .sidebar.open { transform: translateX(0); }
            .content { margin-left: 0; width: 100%; padding: 1.5rem; padding-top: calc(var(--mobile-header-height) + 1.5rem); }
            .mobile-header { display: flex; }
        }
        @media (min-width: 768px) {
            .chat-sidebar { width: 130px; position: static; transform: none; }
            .chat-area { flex-grow: 1; position: static; transform: none; }
        }
        @media (max-width: 767px) {
            .content { padding: 1rem; padding-top: calc(var(--mobile-header-height) + 1rem); }
            .page-header { margin-bottom: 1.5rem; }
            .page-header h2 { font-size: 1.75rem; }
            .fc .fc-toolbar.fc-header-toolbar { flex-direction: column; align-items: center; gap: 0.75rem; }
            .fc .fc-toolbar-chunk:nth-child(2) { order: -1; }
            .fc .fc-toolbar-title { font-size: 1.25rem; }
            #chat-window { width: calc(100% - 20px); height: calc(100% - 80px); bottom: 70px; right: 10px; }
            .chat-header .chat-back-btn { display: block; }
        }
        @media (min-width: 993px) { .mobile-header { display: none; } }
    </style>
</head>
<body>
    <div id="app-loader"><div class="spinner"></div></div>

    <header class="mobile-header">
        <button class="hamburger-btn" onclick="GymApp.toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="mobile-header-title">GymApp Pro</div>
        <div></div>
    </header>
    
    <div id="app-container" style="display: none;">
        <div class="sidebar-overlay" onclick="GymApp.closeSidebar()"></div>
        <div class="main-container">
            <nav class="sidebar">
                <div class="sidebar-header">
                    <h4 class="mb-0"><i class="fas fa-dumbbell me-2"></i> GymApp Pro</h4>
                </div>
                <div class="user-profile-summary">
                    <div id="profile-avatar" class="profile-avatar"></div>
                    <h5 id="profile-name" class="mb-0"></h5>
                    <p id="profile-role" class="small mb-0"></p>
                </div>
                <div class="sidebar-nav-container">
                    <ul class="nav nav-pills flex-column" id="main-nav"></ul>
                </div>
                <div class="sidebar-footer">
                    <div class="theme-switch-wrapper d-flex justify-content-center mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="themeSwitch">
                            <label class="form-check-label" for="themeSwitch">Modo Oscuro</label>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-danger" onclick="GymApp.logout()"><i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </nav>
            <main class="content"></main>
        </div>

        <div id="chat-bubble" onclick="Chat.toggleWindow()">
            <i class="fas fa-comments"></i>
            <div class="notification-dot"></div>
        </div>
        <div id="chat-window">
            <div class="chat-main-container">
                <div class="chat-sidebar">
                    <ul class="chat-contact-list" id="chat-contact-list"></ul>
                </div>
                <div class="chat-area">
                    <div class="chat-header">
                        <button class="chat-back-btn" onclick="Chat.showContactListMobile()"><i class="fas fa-arrow-left"></i></button>
                        <h5 id="chat-with-name" class="mb-0 me-auto"></h5>
                        <button type="button" class="btn-close" onclick="Chat.toggleWindow()"></button>
                    </div>
                    <div class="chat-messages" id="chat-messages-area"></div>
                    <div class="chat-input">
                        <form id="chat-form" onsubmit="Chat.sendMessage(event)">
                            <div class="input-group">
                                <input type="text" id="chat-message-input" class="form-control" placeholder="Escribe un mensaje..." autocomplete="off">
                                <button class="btn btn-primary" type="submit"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <section id="login-section" class="page-section active">
        <div class="login-container text-center">
            <h1 class="mb-2 display-4"><i class="fas fa-dumbbell"></i> GymApp Pro</h1>
            <p class="mb-4 fs-5 text-muted">Selecciona un rol para simular el inicio de sesi√≥n</p>
            <div class="d-grid gap-3">
                <button class="btn btn-primary" onclick="GymApp.login('admin')"><i class="fas fa-user-shield me-2"></i> Administrador</button>
                <button class="btn btn-info text-white" onclick="GymApp.login('professor')"><i class="fas fa-chalkboard-teacher me-2"></i> Profesor</button>
                <button class="btn btn-success" onclick="GymApp.login('student')"><i class="fas fa-user-graduate me-2"></i> Alumno</button>
            </div>
        </div>
    </section>
    
    <div class="modal fade" id="mainModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="mainModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="mainModalBody"></div><div class="modal-footer" id="mainModalFooter"></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const GymApp = {
            state: {
                currentUser: null,
                currentTheme: 'light',
                defaultData: {
                    users: {
                        'user-100': { id: 100, role: 'admin', name: 'Admin General', profile: { email: 'admin@gymapp.com', phone: '911111111' }, password: '1234' },
                        'user-101': { id: 101, role: 'professor', name: 'Carlos Rivas', profile: { email: 'carlos.profe@gymapp.com', phone: '922222222' }, password: '1234' },
                        'user-102': { id: 102, role: 'professor', name: 'Laura G√≥mez', profile: { email: 'laura.profe@gymapp.com', phone: '933333333' }, password: '1234' },
                        'user-1': { 
                            id: 1, role: 'student', name: 'Juan P√©rez', profile: { email: 'juan.perez@email.com', phone: '987654321' }, password: '1234',
                            planId: 1, membershipStartDate: '2025-10-01', attendance: 18, professorId: 101, lastSeen: '2025-10-21T18:30:15',
                            routine: { Lunes: { exercises: [ { id: 1, exerciseId: 1, weight: '60kg', series: 4, reps: 10 } ], completionHistory: [] }, Martes: { exercises: [ { id: 4, exerciseId: 6, weight: '50kg', series: 4, reps: 10 } ], completionHistory: [] }, Mi√©rcoles: { exercises: [], isRestDay: false }, Jueves: { exercises: [ { id: 8, exerciseId: 3, weight: '80kg', series: 4, reps: 10 } ], completionHistory: [] }, Viernes: { exercises: [] }, S√°bado: { exercises: [] }, Domingo: { exercises: [], isRestDay: true } },
                            progress: { labels: ['Julio', 'Agosto', 'Septiembre', 'Octubre'], weights: [85, 84, 82, 80], bodyFat: [22, 21, 20, 18.5], measurements: { chest: [102, 103, 103, 104], waist: [90, 88, 86, 85], hips: [100, 99, 99, 98] } },
                            evaluations: [ { date: '2025-09-15', weight: 82, bodyFat: 20, notes: 'Buena adherencia al plan. Se observa mejora en la t√©cnica de sentadilla.', measurements: { chest: 103, waist: 86, hips: 99 } } ],
                            goals: { weight: 78, bodyFat: 16, measurements: { waist: 82 } }
                        },
                        'user-2': { id: 2, role: 'student', name: 'Maria Rojas', profile: { email: 'maria.r@email.com', phone: '912345678' }, password: '1234', planId: 2, membershipStartDate: '2025-01-15', professorId: 101, lastSeen: '2025-10-21T09:15:30', routine: { Lunes: {isRestDay: true }, Martes: {}, Mi√©rcoles: {}, Jueves: {}, Viernes: {}, S√°bado: {}, Domingo: {isRestDay: true } }, evaluations: [], goals: {} },
                        'user-3': { id: 3, role: 'student', name: 'Carlos Vera', profile: { email: 'carlos.v@email.com', phone: '955555555' }, password: '1234', planId: 1, membershipStartDate: '2024-09-10', professorId: 102, lastSeen: '2025-10-21T17:02:00', routine: { Lunes: {}, Martes: {}, Mi√©rcoles: {isRestDay: true}, Jueves: {}, Viernes: {}, S√°bado: {}, Domingo: {isRestDay: true } }, evaluations: [], goals: {} },
                        'user-4': { id: 4, role: 'student', name: 'Ana Torres', profile: { email: 'ana.t@email.com', phone: '944444444' }, password: '1234', planId: null, membershipStartDate: null, professorId: null, lastSeen: '2025-10-18T11:00:00', routine: {}, evaluations: [], goals: {} },
                    },
                    navigation: {
                        admin: [{ id: 'dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' }, { id: 'crm', icon: 'fa-users', text: 'CRM Socios' }, { id: 'plans', icon: 'fa-id-card', text: 'Planes' }, { id: 'billing', icon: 'fa-file-invoice-dollar', text: 'Pagos y POS' }, { id: 'schedule', icon: 'fa-calendar-alt', text: 'Agenda' }, { id: 'facilities', icon: 'fa-wrench', text: 'Instalaciones'}, { id: 'attendance-log', icon: 'fa-clipboard-list', text: 'Asistencia' }, { id: 'inventory', icon: 'fa-boxes', text: 'Inventario' }, { id: 'profile', icon: 'fa-user-cog', text: 'Mi Perfil' }],
                        professor: [{ id: 'dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' }, { id: 'manage-students', icon: 'fa-users-cog', text: 'Gestionar Alumnos' }, { id: 'routine-builder', icon: 'fa-dumbbell', text: 'Rutinas' }, { id: 'evaluations', icon: 'fa-clipboard-list', text: 'Evaluaciones' }, { id: 'exercise-library', icon: 'fa-book', text: 'Biblioteca Ejercicios' }, { id: 'schedule', icon: 'fa-calendar-check', text: 'Mi Agenda' }, { id: 'profile', icon: 'fa-user-edit', text: 'Mi Perfil' }],
                        student: [ { id: 'dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' }, { id: 'billing', icon: 'fa-wallet', text: 'Mi Plan' }, { id: 'my-routine', icon: 'fa-dumbbell', text: 'Mi Rutina' }, { id: 'my-progress', icon: 'fa-chart-line', text: 'Mi Progreso' }, { id: 'exercise-library', icon: 'fa-book', text: 'Ver Ejercicios' }, { id: 'schedule', icon: 'fa-calendar-plus', text: 'Clases' }, { id: 'my-classes', icon: 'fa-history', text: 'Mis Clases'}, { id: 'profile', icon: 'fa-user', text: 'Mi Perfil' } ]
                    },
                    gymData: {
                        stats: { monthlyNewMembers: 12, monthlyCancellations: 3 },
                        membershipPlans: [ 
                            { id: 1, name: 'Mensual Fit', price: 49990, durationDays: 30, description: 'Acceso completo por 30 d√≠as.', benefits: ['Acceso a todas las √°reas', 'Clases grupales ilimitadas'], rules: { allowFreeze: false } }, 
                            { id: 2, name: 'Anual Pro', price: 499990, durationDays: 365, description: 'Acceso por un a√±o con descuento.', benefits: ['Todo lo de Mensual Fit', '2 evaluaciones gratis', 'Toalla de servicio'], rules: { allowFreeze: true } }
                        ],
                        classes: [ 
                            { id: 1, title: 'Yoga', start: '2025-10-22T10:30:00', spots: 15, teacher: 'Laura G√≥mez', reservedBy: [1,2] }, 
                            { id: 2, title: 'Funcional', start: '2025-10-22T19:00:00', spots: 20, teacher: 'Carlos Rivas', reservedBy: [1] },
                            { id: 3, title: 'Spinning', start: '2025-10-21T20:30:00', spots: 20, teacher: 'Carlos Rivas', reservedBy: [] },
                            { id: 4, title: 'Boxeo', start: '2025-10-21T21:30:00', spots: 20, teacher: 'Carlos Rivas', reservedBy: [1] },
                        ],
                        exerciseLibrary: [
                            { id: 1, name: 'Press de Banca', muscleGroup: 'Pecho', equipment: 'Barra', videoUrl: 'https://www.youtube.com/embed/rxD321l2svE', instructions: ['Acu√©state en el banco plano con los pies firmes en el suelo.', 'Sujeta la barra con un agarre un poco m√°s ancho que tus hombros.', 'Baja la barra de forma controlada hasta que toque tu pecho.', 'Empuja la barra hacia arriba hasta extender los codos, sin bloquearlos.'], tips: 'Mant√©n los om√≥platos retra√≠dos y el arco lumbar natural para proteger tus hombros.'},
                            { id: 2, name: 'Dominadas', muscleGroup: 'Espalda', equipment: 'Peso Corporal', videoUrl: 'https://www.youtube.com/embed/eGo4IYlbE5g', instructions: ['Sujeta la barra con un agarre prono (palmas hacia afuera), un poco m√°s ancho que los hombros.', 'Comienza colgado con los brazos completamente extendidos.', 'Tira de tu cuerpo hacia arriba hasta que tu barbilla sobrepase la barra.', 'Baja de forma controlada hasta la posici√≥n inicial.'], tips: 'Evita el balanceo (kipping) si tu objetivo es la fuerza. Aprieta el abdomen y los gl√∫teos.' },
                            { id: 3, name: 'Sentadilla con Barra', muscleGroup: 'Piernas', equipment: 'Barra', videoUrl: 'https://www.youtube.com/embed/gcnhwCE1z9o', instructions: ['Coloca la barra sobre tus trapecios, no sobre el cuello.', 'Sit√∫a los pies a la anchura de los hombros, con las puntas ligeramente hacia afuera.', 'Baja la cadera como si te fueras a sentar en una silla, manteniendo la espalda recta.', 'Desciende hasta que tus muslos est√©n paralelos al suelo o m√°s abajo, si tu movilidad lo permite.', 'Sube de forma explosiva, empujando con toda la planta del pie.'], tips: 'Mant√©n el pecho erguido y la mirada al frente para no inclinarte demasiado hacia adelante.' },
                            { id: 4, name: 'Curl de B√≠ceps', muscleGroup: 'Brazos', equipment: 'Mancuernas', videoUrl: 'https://www.youtube.com/embed/av7-8igSXTs', instructions: ['De pie, sujeta una mancuerna en cada mano con agarre supino (palmas hacia arriba).', 'Mant√©n los codos pegados a los costados del cuerpo.', 'Sube una mancuerna contrayendo el b√≠ceps, sin mover el codo de su sitio.', 'Baja de forma controlada y repite con el otro brazo.'], tips: 'No uses el impulso de la espalda para levantar el peso. Si lo haces, reduce la carga.' },
                            { id: 5, name: 'Peso Muerto Rumano', muscleGroup: 'Piernas', equipment: 'Barra', videoUrl: 'https://www.youtube.com/embed/cs-g_o_iOBE', instructions: ['Sujeta una barra con un agarre prono frente a tus muslos.', 'Con las rodillas casi rectas (una ligera flexi√≥n), inclina el torso hacia adelante desde la cadera.', 'Mant√©n la espalda completamente recta durante todo el movimiento.', 'Baja la barra hasta que sientas un estiramiento profundo en los isquiotibiales.', 'Sube contrayendo los gl√∫teos y los isquiotibiales.'], tips: 'Piensa en empujar la cadera hacia atr√°s en lugar de simplemente bajar el torso.'},
                            { id: 6, name: 'Remo con Barra', muscleGroup: 'Espalda', equipment: 'Barra', videoUrl: 'https://www.youtube.com/embed/l1hZ1T3G2EI', instructions: ['Inclina tu torso hacia adelante hasta que quede casi paralelo al suelo, manteniendo la espalda recta.', 'Sujeta la barra con un agarre prono, un poco m√°s ancho que tus hombros.', 'Tira de la barra hacia la parte baja de tu abdomen, contrayendo los m√∫sculos de la espalda.', 'Baja la barra de forma controlada.'], tips: 'Aprieta los om√≥platos en la parte alta del movimiento para una m√°xima contracci√≥n.'},
                            { id: 7, name: 'Press Militar', muscleGroup: 'Hombros', equipment: 'Barra', videoUrl: 'https://www.youtube.com/embed/2yjwXTZQDDI', instructions: ['Sentado o de pie, sujeta la barra a la altura de la clav√≠cula con un agarre prono.', 'Empuja la barra verticalmente hacia arriba hasta extender los brazos por completo.', 'Baja de forma controlada a la posici√≥n inicial.'], tips: 'Mant√©n el abdomen contra√≠do para proteger la zona lumbar, especialmente al hacerlo de pie.'}
                        ],
                        inventory: [ { id: 101, sku: 'AG-500', name: 'Agua Mineral 500ml', stock: 150, price: 1000 }, { id: 102, sku: 'PRO-BAR-CH', name: 'Barra Prote√≠na Chocolate', stock: 75, price: 2500 } ],
                        attendanceLog: [ { memberId: 1, timestamp: '2025-10-21T08:05:12' }, { memberId: 2, timestamp: '2025-10-21T09:15:30' }, { memberId: 3, timestamp: '2025-10-21T17:02:00' }, { memberId: 1, timestamp: '2025-10-21T18:30:15' }, { memberId: 2, timestamp: '2025-10-20T19:00:05' }, { memberId: 1, timestamp: '2025-10-19T08:00:21' } ],
                        transactions: [ {id: 1, date: '2025-10-21', description: 'Venta POS', amount: 3500, method: 'Efectivo'}, {id: 2, date: '2025-10-21', description: 'Membres√≠a', amount: 49990, method: 'Tarjeta'}, {id: 3, date: '2025-10-21', description: 'Venta POS', amount: 2500, method: 'Tarjeta'} ],
                        equipment: [
                            { id: 1, name: 'Cinta de Correr #1', type: 'Cardio', status: 'Operativo', lastMaintenance: '2025-09-15', nextMaintenance: '2025-12-15', technician: 'Juan Silva - TecnicoFit', notes: '' },
                            { id: 2, name: 'Prensa de Piernas', type: 'Fuerza', status: 'En Mantenimiento', lastMaintenance: '2025-10-20', nextMaintenance: '2025-10-25', technician: 'Pedro Gonzalez', notes: 'Revisi√≥n de polea principal.' },
                            { id: 3, name: 'Bicicleta Spinning #5', type: 'Cardio', status: 'Averiado', lastMaintenance: '2025-08-01', nextMaintenance: null, technician: 'Juan Silva - TecnicoFit', notes: 'Pedal izquierdo suelto, no usar.' }
                        ],
                        cart: [],
                    }
                },
                data: {}
            },
            
            elements: {},
            calendar: null,
            charts: {},
            mainModal: null,

            init() {
                this.elements.mainContent = document.querySelector('.content');
                this.elements.themeSwitch = document.getElementById('themeSwitch');
                this.elements.sidebarOverlay = document.querySelector('.sidebar-overlay');
                this.elements.appLoader = document.getElementById('app-loader');
                this.elements.navContainer = document.querySelector('.sidebar-nav-container');
                this.mainModal = new bootstrap.Modal(document.getElementById('mainModal'));

                this.loadState();
                
                this.elements.themeSwitch.addEventListener('change', (e) => this.setTheme(e.target.checked ? 'dark' : 'light'));
                window.addEventListener('resize', () => this.checkScrollIndicator());

                if(this.elements.navContainer) {
                    this.elements.navContainer.addEventListener('scroll', (e) => {
                        const el = e.target;
                        const scrollableHeight = el.scrollHeight - el.clientHeight;
                        if (scrollableHeight > 0) {
                            const scrollPercentage = el.scrollTop / scrollableHeight;
                            const opacity = Math.max(0, 1 - (scrollPercentage / 0.8));
                            el.style.setProperty('--scroll-indicator-opacity', opacity);
                        }
                    });
                }

                if (!this.state.currentUser) {
                    const initialTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                    this.setTheme(initialTheme);
                    setTimeout(() => {
                        this.elements.appLoader.style.opacity = '0';
                        setTimeout(() => this.elements.appLoader.style.display = 'none', 500);
                    }, 300);
                }
            },

            saveState() {
                const stateToSave = { 
                    currentUser: this.state.currentUser, 
                    currentTheme: this.state.currentTheme, 
                    data: this.state.data,
                    chat: Chat.state
                };
                localStorage.setItem('gymAppState', JSON.stringify(stateToSave));
            },

            loadState() {
                const savedStateJSON = localStorage.getItem('gymAppState');
                this.state.data = JSON.parse(JSON.stringify(this.state.defaultData));

                if (!savedStateJSON) return;
                
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    if (savedState.data) this.state.data = savedState.data;
                    if (savedState.chat) Chat.state = savedState.chat;
                    
                    const savedUser = savedState.currentUser;
                    if (savedUser && savedUser.id) {
                        const user = Object.values(this.state.data.users).find(u => u.id === savedUser.id);
                        if (user) {
                            this.state.currentUser = user;
                            this.state.currentTheme = savedState.currentTheme || 'light';
                            document.getElementById('login-section').style.display = 'none';
                            document.getElementById('app-container').style.display = 'block';
                            this.setTheme(this.state.currentTheme);
                            this.setupUIForRole();
                            this.navigateTo('dashboard');
                            Chat.init();
                            
                            this.elements.appLoader.style.opacity = '0';
                            setTimeout(() => this.elements.appLoader.style.display = 'none', 500);
                        }
                    }
                } catch (e) {
                    console.error("Failed to parse saved state:", e);
                    localStorage.removeItem('gymAppState');
                }
            },
            
            setTheme(theme) {
                this.state.currentTheme = theme;
                document.body.className = theme === 'dark' ? 'dark-mode' : '';
                this.elements.themeSwitch.checked = theme === 'dark';
                this.saveState();
                if (Object.keys(this.charts).length > 0) {
                    if (this.state.currentUser?.role === 'student') this.updateStudentCharts();
                    if (this.state.currentUser?.role === 'admin') this.renderAdminCharts();
                }
                if (this.calendar) setTimeout(() => this.calendar.render(), 1);
            },

            login(role) {
                const user = Object.values(this.state.data.users).find(u => u.role === role);
                if (!user) return;
                this.state.currentUser = user;
                Chat.state = { isOpen: false, activeConversationId: null, conversations: {}, hasUnread: false };
                document.getElementById('login-section').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    this.setupUIForRole();
                    this.navigateTo('dashboard');
                    Chat.init();
                    this.saveState();
                }, 300);
            },
            
            logout() {
                this.state.currentUser = null;
                localStorage.removeItem('gymAppState');
                location.reload();
            },
            
            navigateTo(sectionId) {
                this.renderSection(sectionId);
                document.querySelectorAll('#main-nav .nav-link').forEach(l => l.classList.remove('active'));
                const activeLink = document.querySelector(`#main-nav .nav-link[data-section="${sectionId}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
                if (window.innerWidth <= 992) {
                    this.closeSidebar();
                }
            },

            closeSidebar() {
                document.querySelector('.sidebar').classList.remove('open');
                this.elements.sidebarOverlay.classList.remove('active');
                document.body.classList.remove('sidebar-is-open');
            },

            toggleSidebar() {
                const sidebar = document.querySelector('.sidebar');
                const isOpen = sidebar.classList.toggle('open');
                this.elements.sidebarOverlay.classList.toggle('active', isOpen);
                document.body.classList.toggle('sidebar-is-open', isOpen);
            },
            
            renderSection(sectionId) {
                const role = this.state.currentUser.role;
                let content = `<div class="card"><div class="card-body"><h3>Error</h3><p>Secci√≥n no encontrada para el rol '${role}'.</p></div></div>`;
                if (this.templates[sectionId]) {
                    if (typeof this.templates[sectionId] === 'function') {
                        content = this.templates[sectionId]();
                    } else if (this.templates[sectionId][role]) {
                        content = this.templates[sectionId][role]();
                    }
                }
                this.elements.mainContent.innerHTML = content;
                this.runPostRenderScripts(sectionId);
            },

            runPostRenderScripts(sectionId) {
                const role = this.state.currentUser.role;
                if (sectionId === 'schedule') {
                    const btn = document.getElementById('add-class-btn');
                    btn.style.display = (role === 'admin' || role === 'professor') ? 'block' : 'none';
                    btn.onclick = () => this.showClassFormModal();
                    this.initializeCalendar(role);
                }
                if (sectionId === 'exercise-library') {
                    this.renderExerciseLibrary();
                }
                if (role === 'admin') {
                    if (sectionId === 'dashboard') this.renderAdminCharts();
                    if (sectionId === 'crm') this.updateAdminCRMTable();
                    if (sectionId === 'inventory') this.updateAdminInventoryTable();
                    if (sectionId === 'plans') this.updateAdminPlansUI();
                    if (sectionId === 'billing') { this.updateAdminPosItems(); this.updateCart(); }
                    if (sectionId === 'attendance-log') this.updateAdminAttendanceTable();
                    if (sectionId === 'facilities') this.updateFacilitiesTable();
                }
                if (role === 'professor') {
                    if (sectionId === 'routine-builder') this.updateProfessorRoutineBuilderUI();
                    if (sectionId === 'manage-students') this.updateManageStudentsUI();
                }
                if (role === 'student') {
                    if (sectionId === 'billing') this.updateStudentPlanUI();
                    if (sectionId === 'my-routine') this.updateStudentRoutineUI();
                    if (sectionId === 'my-progress') { this.updateStudentCharts(); this.updateStudentGoalsUI(); }
                    if (sectionId === 'my-classes') this.updateStudentClassesHistory();
                }
            },
            
            setupUIForRole() {
                const { role, name } = this.state.currentUser;
                document.getElementById('profile-name').innerText = name;
                document.getElementById('profile-role').innerText = role.charAt(0).toUpperCase() + role.slice(1);
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                document.getElementById('profile-avatar').innerText = initials;
                document.getElementById('main-nav').innerHTML = this.state.defaultData.navigation[role]
                    .map(l => `<li class="nav-item"><span class="nav-link" data-section="${l.id}" onclick="GymApp.navigateTo('${l.id}')"><i class="fas ${l.icon} fa-fw me-2"></i>${l.text}</span></li>`)
                    .join('');
                this.checkScrollIndicator();
            },

            checkScrollIndicator() {
                if (!this.elements.navContainer) return;
                setTimeout(() => {
                    const navContainer = this.elements.navContainer;
                    if (navContainer.scrollHeight > navContainer.clientHeight) {
                        navContainer.classList.add('is-scrollable');
                    } else {
                        navContainer.classList.remove('is-scrollable');
                    }
                }, 100); 
            },

            updateStudentRoutineUI(studentId = null) {
                const user = studentId ? Object.values(this.state.data.users).find(u => u.id === studentId) : this.state.currentUser;
                if (!user) return;

                const isOwnerView = !studentId || user.id === this.state.currentUser.id;
                const canEdit = this.state.currentUser.role === 'professor' || (this.state.currentUser.role === 'student' && isOwnerView);
                
                const containerId = (this.state.currentUser.role === 'student' && isOwnerView) ? 'routine-cards-container' : 'routine-builder-body';
                const container = document.getElementById(containerId);
                
                if (!container) return;
                if (!user.routine) user.routine = {};

                const daysOfWeek = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
                const todayName = daysOfWeek[new Date().getDay() - 1] ?? "Domingo";
                const todayISO = new Date().toISOString().split('T')[0];

                container.innerHTML = daysOfWeek.map(day => {
                    const dayInfo = user.routine[day] || {};
                    const dayData = { exercises: dayInfo.exercises || [], completionHistory: dayInfo.completionHistory || [], isRestDay: dayInfo.isRestDay || false };
                    const isToday = day === todayName && isOwnerView;
                    const isTodayCompleted = isOwnerView && dayData.completionHistory.includes(todayISO);
                    const isRestDay = dayData.isRestDay;

                    const completionSwitchHTML = isOwnerView && !isRestDay
                        ? `<div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="check-${day}" ${isTodayCompleted ? 'checked' : ''} onchange="GymApp.toggleCompletionForToday('${day}')"><label class="form-check-label" for="check-${day}">${isTodayCompleted ? 'Completado' : 'Marcar'}</label></div>`
                        : '';
                    
                    let cardBodyHTML;
                    if (isRestDay) {
                        cardBodyHTML = `<div class="text-center p-4 text-muted"><i class="fas fa-bed fa-3x mb-3"></i><h4>D√≠a de Descanso</h4></div>`;
                    } else if (dayData.exercises.length > 0) {
                        cardBodyHTML = `<ul class="list-group list-group-flush">${dayData.exercises.map(ex => {
                            const exerciseInfo = this.state.data.gymData.exerciseLibrary.find(e => e.id === ex.exerciseId) || { name: 'Ejercicio no encontrado' };
                            return `<li class="list-group-item d-flex justify-content-between align-items-center"><div><div class="fw-bold">${exerciseInfo.name}</div><small class="text-muted">${ex.series || 'N/A'}s &times; ${ex.reps || 'N/A'}r @ ${ex.weight || 'N/A'}</small></div>${ canEdit ? `<div class="dropdown"><button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button><ul class="dropdown-menu"><li><a class="dropdown-item" href="#" onclick="GymApp.showEditExerciseModal('${day}',${ex.id},${user.id})">Editar</a></li><li><a class="dropdown-item text-danger" href="#" onclick="GymApp.deleteExercise('${day}',${ex.id},${user.id})">Eliminar</a></li></ul></div>` : '' }</li>`
                        }).join('')}</ul>`;
                    } else {
                        cardBodyHTML = `<div class="text-center p-3 text-muted"><i class="fas fa-coffee fa-2x mb-2"></i><p>D√≠a libre o sin planificar.</p></div>`;
                    }

                    let footerHTML = '';
                    if (canEdit) {
                        if (isRestDay) {
                            footerHTML = `<div class="card-footer"><button class="btn btn-sm btn-outline-secondary w-100" onclick="GymApp.toggleRestDay('${day}', ${user.id})"><i class="fas fa-briefcase me-2"></i>Quitar Descanso</button></div>`;
                        } else {
                            footerHTML = `<div class="card-footer d-grid gap-2"><button class="btn btn-sm btn-outline-primary" onclick="GymApp.showEditExerciseModal('${day}', null, ${user.id})"><i class="fas fa-plus me-2"></i>A√±adir Ejercicio</button><button class="btn btn-sm btn-outline-secondary" onclick="GymApp.toggleRestDay('${day}', ${user.id})"><i class="fas fa-bed me-2"></i>Marcar como Descanso</button></div>`;
                        }
                    }

                    return `<div class="card routine-day-card mb-3 ${isToday ? 'is-today' : ''} ${isTodayCompleted ? 'is-today-completed' : ''} ${isRestDay ? 'is-rest-day' : ''}" id="card-${day}-${user.id}">
                        <div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0">${day}</h5>${completionSwitchHTML}</div>
                        ${cardBodyHTML}
                        ${footerHTML}
                    </div>`;
                }).join('');

                if (isToday) {
                    const todayCard = document.getElementById(`card-${todayName}-${user.id}`);
                    if (todayCard) {
                        todayCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            
            updateProfessorRoutineBuilderUI() {
                const studentListEl = document.getElementById('professor-student-list');
                const myStudents = Object.values(this.state.data.users).filter(u => u.role === 'student' && u.professorId === this.state.currentUser.id);
                if(myStudents.length > 0) {
                    studentListEl.innerHTML = myStudents.map(m => `<a href="#" class="list-group-item list-group-item-action" data-student-id="${m.id}" onclick="GymApp.loadRoutineForStudent(${m.id}, this)">${m.name}</a>`).join('');
                } else {
                    studentListEl.innerHTML = `<li class="list-group-item text-muted text-center">No tienes alumnos asignados. Ve a "Gestionar Alumnos".</li>`;
                }
            },
            
            loadRoutineForStudent(studentId, el) {
                document.querySelectorAll('#professor-student-list .list-group-item, #my-students-list .list-group-item').forEach(e => e.classList.remove('active'));
                if (el) el.classList.add('active');
                
                const student = Object.values(this.state.data.users).find(u => u.id === studentId);
                if (student) {
                    document.getElementById('routine-builder-header').innerHTML = `<h5>Editando rutina de: <strong>${student.name}</strong></h5>`;
                    this.updateStudentRoutineUI(student.id);
                }
            },
            
            showToast(title, text, icon = 'success') {
                Swal.fire({ title, text, icon, timer: 2000, showConfirmButton: false, toast: true, position: 'top-end' });
            },

            filterTable(query, containerId) {
                query = query.toLowerCase();
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const items = container.querySelectorAll('[data-name]');
                
                items.forEach(item => {
                    const name = item.dataset.name || '';
                    item.style.display = name.includes(query) ? '' : 'none';
                });
            },

            formatCurrency(number) {
                return '$' + new Intl.NumberFormat('es-CL').format(number);
            },
            openChatWithStudent(studentId) {
                const professorId = this.state.currentUser.id;
                const convoId = `convo_${professorId}_${studentId}`;
                
                if (!Chat.state.isOpen) {
                    Chat.toggleWindow();
                }
                
                // Peque√±o delay para asegurar que la ventana est√° visible antes de cambiar la conversaci√≥n
                setTimeout(() => {
                    Chat.openConversation(convoId);
                }, 100);
            }
        };

        const Chat = {
            state: {
                isOpen: false,
                activeConversationId: null,
                conversations: {},
                hasUnread: false,
            },
            elements: {},

            init() {
                this.elements.bubble = document.getElementById('chat-bubble');
                this.elements.notificationDot = document.querySelector('#chat-bubble .notification-dot');
                this.elements.window = document.getElementById('chat-window');
                this.elements.contactList = document.getElementById('chat-contact-list');
                this.elements.chatWithName = document.getElementById('chat-with-name');
                this.elements.messagesArea = document.getElementById('chat-messages-area');
                this.elements.messageInput = document.getElementById('chat-message-input');
                this.setupConversations();
                this.renderContactList();
                if(this.state.activeConversationId) {
                    this.openConversation(this.state.activeConversationId, true);
                }
                this.checkUnreadMessages();
            },
            
            toggleWindow() {
                this.state.isOpen = !this.state.isOpen;
                this.elements.window.classList.toggle('open', this.state.isOpen);
                if(this.state.isOpen && this.state.activeConversationId && window.innerWidth < 768) {
                    this.elements.window.classList.remove('mobile-chat-view');
                } else if (this.state.isOpen && this.state.activeConversationId) {
                     this.openConversation(this.state.activeConversationId);
                }
            },
            
            setupConversations() {
                const role = GymApp.state.currentUser.role;
                const userId = GymApp.state.currentUser.id;
                const todayString = new Date().toISOString().split('T')[0];

                if(Object.keys(this.state.conversations).filter(k => !k.startsWith('group_class_')).length === 0) {
                    this.state.conversations = {};
                     if (role === 'student') {
                        const professorId = GymApp.state.currentUser.professorId;
                        if(professorId) {
                            const professor = Object.values(GymApp.state.data.users).find(u => u.id === professorId);
                            const convoId = `convo_${userId}_${professorId}`;
                            this.state.conversations[convoId] = { id: convoId, with: professor.name, withUserId: professor.id, messages: [{type: 'received', text: '¬°Hola! Soy tu profesor. ¬øEn qu√© puedo ayudarte hoy?'}] };
                        }
                    }
                    if (role === 'professor') {
                        const myStudents = Object.values(GymApp.state.data.users).filter(u => u.role === 'student' && u.professorId === userId);
                        myStudents.forEach(student => {
                            const convoId = `convo_${userId}_${student.id}`;
                            this.state.conversations[convoId] = { id: convoId, with: student.name, withUserId: student.id, messages: [{type: 'received', text: `Hola, ${student.name}. ¬øTienes alguna duda?`}] };
                        });
                    }
                    if (role === 'admin') {
                        this.state.conversations['announcements'] = { id: 'announcements', with: 'Anuncios', withUserId: null, icon: 'fa-bullhorn', messages: [{type: 'received', text: 'Canal de anuncios generales.'}] };
                    }
                }
                
                const classesToday = GymApp.state.data.gymData.classes.filter(c => c.start.startsWith(todayString));
                classesToday.forEach(c => {
                    const isTeacher = c.teacher === GymApp.state.currentUser.name;
                    const isEnrolled = c.reservedBy.includes(userId);
                    if (isTeacher || isEnrolled) {
                        const convoId = `group_class_${c.id}`;
                        if (!this.state.conversations[convoId]) {
                             this.state.conversations[convoId] = { id: convoId, with: `Grupo: ${c.title}`, withUserId: null, icon: 'fa-users', messages: [{type: 'received', text: `¬°Bienvenidos al grupo de la clase de ${c.title}!`}] };
                        }
                    }
                });

                if(!this.state.activeConversationId && Object.keys(this.state.conversations).length > 0) {
                    this.state.activeConversationId = Object.keys(this.state.conversations)[0];
                }
                GymApp.saveState();
            },
            
            renderContactList() {
                this.elements.contactList.innerHTML = '';
                Object.values(this.state.conversations).forEach(convo => {
                    const li = document.createElement('li');
                    li.className = `chat-contact-item ${convo.id === this.state.activeConversationId ? 'active' : ''}`;
                    li.onclick = () => this.openConversation(convo.id);
                    
                    let avatarHTML;
                    if (convo.icon) {
                        avatarHTML = `<div class="contact-avatar"><i class="fas ${convo.icon}"></i></div>`;
                    } else if (convo.withUserId) {
                        const user = Object.values(GymApp.state.data.users).find(u => u.id === convo.withUserId);
                        const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                        avatarHTML = `<div class="contact-avatar">${initials}</div>`;
                    }

                    li.innerHTML = `
                        ${avatarHTML}
                        <div class="contact-info">
                            <div class="fw-bold">${convo.with}</div>
                            <small class="text-muted text-truncate d-block">${convo.messages.slice(-1)[0].text}</small>
                        </div>
                    `;
                    this.elements.contactList.appendChild(li);
                });
            },
            
            openConversation(id, isInitialLoad = false) {
                this.state.activeConversationId = id;
                const conversation = this.state.conversations[id];
                if (!conversation) return;

                if(conversation.unread) {
                    conversation.unread = false;
                    this.checkUnreadMessages();
                }

                this.elements.chatWithName.innerText = conversation.with;
                this.renderMessages(conversation.messages);

                if (window.innerWidth < 768 && !isInitialLoad) {
                    this.elements.window.classList.add('mobile-chat-view');
                }
                this.renderContactList();
                GymApp.saveState();
            },
            
            showContactListMobile() {
                this.elements.window.classList.remove('mobile-chat-view');
            },

            renderMessages(messages) {
                this.elements.messagesArea.innerHTML = messages.map(msg => `
                    <div class="chat-message message-${msg.type}">
                        <p>${msg.text}</p>
                    </div>
                `).join('');
                this.elements.messagesArea.scrollTop = this.elements.messagesArea.scrollHeight;
            },
            
            sendMessage(event) {
                event.preventDefault();
                const text = this.elements.messageInput.value.trim();
                if (!text || !this.state.activeConversationId) return;

                const conversation = this.state.conversations[this.state.activeConversationId];
                conversation.messages.push({ type: 'sent', text });
                this.renderMessages(conversation.messages);
                this.elements.messageInput.value = '';

                this.showTypingIndicator();

                setTimeout(() => {
                    this.hideTypingIndicator();
                    const response = this.getSimulatedResponse();
                    conversation.messages.push({ type: 'received', text: response });
                    if(!this.state.isOpen) {
                        conversation.unread = true;
                        this.checkUnreadMessages();
                    }
                    this.renderMessages(conversation.messages);
                    this.renderContactList();
                    GymApp.saveState();
                }, 1500 + Math.random() * 1000);
            },

            showTypingIndicator() {
                if (document.getElementById('typing-indicator')) return;
                const typingEl = document.createElement('div');
                typingEl.id = 'typing-indicator';
                typingEl.className = 'chat-message message-received message-typing';
                typingEl.innerHTML = `<p class="typing-indicator"><span></span><span></span><span></span></p>`;
                this.elements.messagesArea.appendChild(typingEl);
                this.elements.messagesArea.scrollTop = this.elements.messagesArea.scrollHeight;
            },

            hideTypingIndicator() {
                const typingEl = document.getElementById('typing-indicator');
                if (typingEl) typingEl.remove();
            },
            
            getSimulatedResponse() {
                const responses = [ "Entendido, lo revisar√©.", "Gracias por tu mensaje, te responder√© en breve.", "Ok, recibido.", "Perfecto, lo tengo en cuenta.", "¬øHay algo m√°s en lo que pueda ayudarte?", "Claro, d√©jame verificarlo y te comento."];
                return responses[Math.floor(Math.random() * responses.length)];
            },
            
            checkUnreadMessages() {
                this.state.hasUnread = Object.values(this.state.conversations).some(c => c.unread);
                this.elements.notificationDot.style.display = this.state.hasUnread ? 'block' : 'none';
                GymApp.saveState();
            }
        };

        GymApp.templates = {
            dashboard: {
                admin: () => {
                    const students = Object.values(GymApp.state.data.users).filter(u => u.role === 'student');
                    const totalMembers = students.length;
                    const retention = totalMembers > 0 ? 100 - (GymApp.state.data.gymData.stats.monthlyCancellations / totalMembers) * 100 : 100;
                    const delinquent = students.filter(u => GymApp.getUserPlanDetails(u).status === 'Vencido').length;
                    
                    const today = new Date().toISOString().split('T')[0];
                    const dailyTransactions = GymApp.state.data.gymData.transactions.filter(t => t.date === today);
                    const cashTotal = dailyTransactions.filter(t => t.method === 'Efectivo').reduce((sum, t) => sum + t.amount, 0);
                    const cardTotal = dailyTransactions.filter(t => t.method === 'Tarjeta').reduce((sum, t) => sum + t.amount, 0);

                    const expiringSoon = students.filter(u => {
                        const details = GymApp.getUserPlanDetails(u);
                        if (details.status !== 'Activo') return false;
                        const endDate = new Date(details.endDate.split('/').reverse().join('-'));
                        const daysLeft = (endDate - new Date()) / (1000 * 60 * 60 * 24);
                        return daysLeft >= 0 && daysLeft <= 7;
                    }).slice(0, 3).map(m => `<li class="list-group-item d-flex justify-content-between"><span>${m.name}</span> <span class="text-muted">${GymApp.getUserPlanDetails(m).endDate}</span></li>`).join('');

                    return `<div class="page-header"><h2>Dashboard Administrativo</h2><p class="text-muted">Vista general de la operaci√≥n del gimnasio.</p></div>
                    <div class="row">
                        <div class="col-xl-3 col-md-6 mb-4"><div class="stat-card h-100 card" style="--stat-color: var(--primary-color); border-left-color: var(--stat-color);"><div class="card-body"><div><div class="text-xs fw-bold text-uppercase mb-1" style="color:var(--stat-color)">Socios Activos</div><div class="h5 mb-0 fw-bold">${totalMembers}</div></div><i class="fas fa-users"></i></div></div></div>
                        <div class="col-xl-3 col-md-6 mb-4"><div class="stat-card h-100 card" style="--stat-color: var(--info-color); border-left-color: var(--stat-color);"><div class="card-body"><div><div class="text-xs fw-bold text-uppercase mb-1" style="color:var(--stat-color)">Altas del Mes</div><div class="h5 mb-0 fw-bold">+${GymApp.state.data.gymData.stats.monthlyNewMembers}</div></div><i class="fas fa-user-plus"></i></div></div></div>
                        <div class="col-xl-3 col-md-6 mb-4"><div class="stat-card h-100 card" style="--stat-color: var(--success-color); border-left-color: var(--stat-color);"><div class="card-body"><div><div class="text-xs fw-bold text-uppercase mb-1" style="color:var(--stat-color)">Retenci√≥n Mensual</div><div class="h5 mb-0 fw-bold">${retention.toFixed(1)}%</div></div><i class="fas fa-chart-pie"></i></div></div></div>
                        <div class="col-xl-3 col-md-6 mb-4"><div class="stat-card h-100 card" style="--stat-color: var(--danger-color); border-left-color: var(--stat-color);"><div class="card-body"><div><div class="text-xs fw-bold text-uppercase mb-1" style="color:var(--stat-color)">Socios con Morosidad</div><div class="h5 mb-0 fw-bold">${delinquent}</div></div><i class="fas fa-file-invoice-dollar"></i></div></div></div>
                    </div>
                    <div class="row">
                        <div class="col-lg-8 mb-4">
                            <div class="card h-100">
                                <div class="card-header"><h5><i class="fas fa-clock me-2"></i>Asistencia por Hora (Horas Pico)</h5></div>
                                <div class="card-body"><div style="height:300px;"><canvas id="peakHoursChart"></canvas></div></div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="row">
                                <div class="col-12 mb-4">
                                     <div class="card h-100">
                                        <div class="card-header"><h5><i class="fas fa-cash-register me-2"></i>Caja Diaria</h5></div>
                                        <div class="card-body">
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item d-flex justify-content-between align-items-center">Efectivo:<span class="fw-bold">${GymApp.formatCurrency(cashTotal)}</span></li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">Tarjeta:<span class="fw-bold">${GymApp.formatCurrency(cardTotal)}</span></li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center fs-5"><strong>Total:</strong><strong class="text-success">${GymApp.formatCurrency(cashTotal + cardTotal)}</strong></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header"><h5><i class="fas fa-exclamation-triangle me-2"></i>Pr√≥ximos a Vencer</h5></div>
                                        <ul class="list-group list-group-flush">${expiringSoon || '<li class="list-group-item text-muted text-center">Ninguno</li>'}</ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                },
                professor: () => {
                    const myStudents = Object.values(GymApp.state.data.users).filter(u => u.role === 'student' && u.professorId === GymApp.state.currentUser.id);
                    const studentsWithPendingEval = myStudents.filter(s => s.evaluations.length === 0).slice(0, 3);
                    
                    const recentActivity = myStudents
                        .sort((a,b) => new Date(b.lastSeen) - new Date(a.lastSeen))
                        .slice(0, 4)
                        .map(s => {
                            const timeAgo = Math.round((new Date() - new Date(s.lastSeen)) / (1000 * 60 * 60 * 24));
                            return `<li class="list-group-item d-flex justify-content-between align-items-center">
                                <div><strong>${s.name}</strong> <small class="text-muted">se conect√≥</small></div>
                                <span class="badge bg-light text-dark">${timeAgo > 0 ? `hace ${timeAgo}d` : 'hoy'}</span>
                            </li>`
                        }).join('');

                    return `<div class="page-header"><h2>Dashboard del Profesor</h2><p class="text-muted">Resumen de tus actividades, ${GymApp.state.currentUser.name}.</p></div>
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card prof-dash-card mb-4">
                                <div class="card-body">
                                    <i class="fas fa-users icon-bg"></i>
                                    <h5 class="card-title text-white">¬°Hola, ${GymApp.state.currentUser.name}!</h5>
                                    <p class="text-white-50">Tienes <strong>${myStudents.length} alumnos</strong> a tu cargo. Es un buen d√≠a para motivarlos a alcanzar sus metas.</p>
                                    <button class="btn btn-light" onclick="GymApp.navigateTo('manage-students')">Gestionar mis alumnos <i class="fas fa-arrow-right ms-1"></i></button>
                                </div>
                            </div>
                            <div class="card mb-4">
                                <div class="card-header"><h5><i class="fas fa-history me-2 text-info"></i>Actividad Reciente de Alumnos</h5></div>
                                <ul class="list-group list-group-flush">${recentActivity || '<li class="list-group-item text-center text-muted">No hay actividad reciente.</li>'}</ul>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card mb-4">
                                <div class="card-header"><h5><i class="fas fa-calendar-day me-2 text-primary"></i>Mis Clases de Hoy</h5></div>
                                <ul class="list-group list-group-flush">${GymApp.state.data.gymData.classes.filter(c=>c.teacher===GymApp.state.currentUser.name&&new Date(c.start).toDateString()===new Date().toDateString()).map(c=>`<li class="list-group-item d-flex justify-content-between align-items-center">${c.title}<span class="badge bg-primary rounded-pill">${new Date(c.start).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></li>`).join('')||'<li class="list-group-item text-center text-muted">No tienes clases hoy.</li>'}</ul>
                            </div>
                             <div class="card h-100">
                                <div class="card-header"><h5><i class="fas fa-clipboard-question me-2 text-warning"></i>Evaluaciones Pendientes</h5></div>
                                <ul class="list-group list-group-flush">${studentsWithPendingEval.map(s => `<li class="list-group-item d-flex justify-content-between align-items-center">${s.name} <button class="btn btn-sm btn-outline-primary" onclick="GymApp.navigateTo('evaluations'); setTimeout(() => document.querySelector('#evaluation-student-select').value = ${s.id}, 50); GymApp.renderEvaluationForStudent(${s.id});">Evaluar</button></li>`).join('') || '<li class="list-group-item text-center text-muted">Sin pendientes.</li>'}</ul>
                            </div>
                        </div>
                    </div>`;
                },
                student: () => {
                    const s = GymApp.state.currentUser;
                    const planDetails = GymApp.getUserPlanDetails(s);
                    const goal = 20;
                    const progress = Math.min((s.attendance / goal) * 100, 100);
                    const isClaimable = s.attendance >= goal;

                    const daysOfWeek = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
                    const todayName = daysOfWeek[new Date().getDay()];
                    const todaysRoutine = s.routine[todayName];
                    let todayWorkoutHTML = '<div class="text-muted text-center p-3"><i class="fas fa-coffee fa-2x"></i><p>Hoy no tienes rutina asignada.</p></div>';
                    if(todaysRoutine && !todaysRoutine.isRestDay && todaysRoutine.exercises.length > 0) {
                        todayWorkoutHTML = `<ul class="list-group list-group-flush">${todaysRoutine.exercises.slice(0,3).map(ex => {
                            const exInfo = GymApp.state.data.gymData.exerciseLibrary.find(e => e.id === ex.exerciseId) || {name: "Ejercicio desconocido"};
                            return `<li class="list-group-item"><strong>${exInfo.name}</strong> <small class="text-muted">(${ex.series}x${ex.reps})</small></li>`
                        }).join('')}</ul>`;
                    } else if (todaysRoutine && todaysRoutine.isRestDay) {
                         todayWorkoutHTML = '<div class="text-muted text-center p-3"><i class="fas fa-bed fa-2x"></i><p>¬°Hoy es d√≠a de descanso!</p></div>';
                    }

                    const upcomingClasses = GymApp.state.data.gymData.classes.filter(c => c.reservedBy.includes(s.id) && new Date(c.start) > new Date()).slice(0, 2);
                    let upcomingClassesHTML = '<li class="list-group-item text-muted text-center">No tienes pr√≥ximas clases.</li>';
                    if(upcomingClasses.length > 0) {
                        upcomingClassesHTML = upcomingClasses.map(c => `<li class="list-group-item"><strong>${c.title}</strong><br><small>${new Date(c.start).toLocaleString('es-ES', {weekday: 'long', hour: '2-digit', minute: '2-digit'})}</small></li>`).join('');
                    }

                    return `<div class="page-header"><h2>Mi Dashboard</h2><p class="text-muted">¬°Bienvenido de vuelta, ${s.name}!</p></div>
                    <div class="row">
                        <div class="col-lg-8 mb-4">
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                     <div class="card h-100">
                                        <div class="card-header"><h5><i class="fas fa-dumbbell me-2 text-primary"></i>Entrenamiento de Hoy</h5></div>
                                        ${todayWorkoutHTML}
                                        <div class="card-footer"><a href="#" class="btn btn-outline-primary w-100" onclick="GymApp.navigateTo('my-routine')">Ver mi rutina completa</a></div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                     <div class="card h-100">
                                        <div class="card-header"><h5><i class="fas fa-calendar-check me-2 text-info"></i>Pr√≥ximas Clases</h5></div>
                                        <ul class="list-group list-group-flush">${upcomingClassesHTML}</ul>
                                    </div>
                                </div>
                                <div class="col-12">
                                     <div class="card h-100 ${isClaimable ? 'border-success' : ''}">
                                        <div class="card-body">
                                            <h5 class="card-title mb-3"><i class="fas fa-trophy me-2 ${isClaimable ? 'text-warning' : 'text-muted'}"></i>Metas y Recompensas</h5>
                                            <p class="mb-1"><strong>Asistencia este mes:</strong> ${s.attendance} / ${goal} d√≠as.</p>
                                            <div class="progress mb-3" style="height:1.5rem;"><div class="progress-bar bg-success rounded" style="width:${progress}%;">${Math.round(progress)}%</div></div>
                                            <div class="d-grid"><button class="btn ${isClaimable ? 'btn-success' : 'btn-secondary'}" ${!isClaimable ? 'disabled' : ''}>${isClaimable ? '¬°Reclamar Recompensa!' : `Faltan ${goal - s.attendance} d√≠as`}</button></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                             <div class="card h-100">
                                <div class="card-body text-center d-flex flex-column justify-content-center">
                                    <h5 class="card-title"><i class="fas fa-id-card me-2 text-primary"></i>Estado de Membres√≠a</h5>
                                    <p class="fs-4"><strong>${planDetails.name}</strong></p>
                                    <p>Estado: <span class="badge fs-6 ${planDetails.status === 'Activo' ? 'bg-success' : 'bg-danger'}">${planDetails.status}</span></p>
                                    <button class="btn btn-primary mt-3" onclick="GymApp.navigateTo('billing')">Ver detalles de mi plan</button>
                                </div>
                            </div>
                        </div>
                    </div>`; 
                }
            },
            crm: () => `<div class="page-header"><h2><i class="fas fa-users me-2"></i>CRM de Socios</h2><p class="text-muted">Gestiona la informaci√≥n y membres√≠as de todos los socios.</p></div><div class="card"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"><div class="search-input-group flex-grow-1" style="max-width: 400px;"><i class="fas fa-search"></i><input type="text" class="form-control" placeholder="Buscar socio..." onkeyup="GymApp.filterTable(this.value, 'crm-table-body')"></div><div class="btn-group"><button class="btn btn-primary" onclick="GymApp.showCreateUserModal()"><i class="fas fa-user-plus me-2"></i>Nuevo</button><button class="btn btn-outline-secondary" onclick="GymApp.exportCRM()"><i class="fas fa-download me-2"></i>Exportar CSV</button></div></div><div class="table-responsive"><table class="table table-hover align-middle"><thead><tr><th>Socio</th><th>Contacto</th><th>Plan</th><th>Vigencia</th><th>Estado</th><th>Profesor</th><th class="text-end">Acciones</th></tr></thead><tbody id="crm-table-body"></tbody></table></div></div></div>`,
            plans: () => `<div class="page-header d-flex justify-content-between align-items-center"><div><h2><i class="fas fa-id-card me-2"></i>Cat√°logo de Planes</h2><p class="text-muted mb-0">Administra los planes y membres√≠as ofrecidos.</p></div><button class="btn btn-primary" onclick="GymApp.showPlanFormModal()"><i class="fas fa-plus me-2"></i>Crear Plan</button></div><div id="plans-container" class="row"></div>`,
            billing: () => {
                const isAdmin = GymApp.state.currentUser.role === 'admin';
                return `
                <div id="admin-billing-view" style="display:${isAdmin ? 'block' : 'none'}">
                    <div class="page-header"><h2><i class="fas fa-cash-register me-2"></i>Punto de Venta (POS)</h2><p class="text-muted">Realiza ventas de productos y servicios.</p></div>
                    <div class="row">
                        <div class="col-lg-7 mb-4"><div class="card h-100"><div class="card-header"><h5>Productos</h5></div><div class="card-body"><div id="pos-items" class="list-group"></div></div></div></div>
                        <div class="col-lg-5 mb-4"><div class="card h-100"><div class="card-header"><h5>Carrito</h5></div><div class="card-body d-flex flex-column"><ul id="pos-cart" class="list-group mb-3 flex-grow-1" style="overflow-y: auto;"></ul><hr><div class="d-flex justify-content-between align-items-center"><h4>Total:</h4><h4 class="fw-bold"><span id="pos-total">$0</span></h4></div><button class="btn btn-success w-100 mt-3" onclick="GymApp.processPayment()"><i class="fas fa-check me-2"></i>Procesar Pago</button></div></div></div>
                    </div>
                </div>
                <div id="student-billing-view" style="display:${!isAdmin ? 'block' : 'none'}">
                    <div class="page-header"><h2><i class="fas fa-wallet me-2"></i>Mi Plan y Pagos</h2><p class="text-muted">Consulta los detalles de tu membres√≠a y tu historial de pagos.</p></div>
                    <div class="row">
                        <div class="col-lg-5 mb-4">
                            <div class="student-plan-display shadow-lg">
                                <div class="d-flex justify-content-between align-items-start mb-4">
                                    <h3 class="fw-bold" id="student-plan-name">Cargando...</h3>
                                    <span class="badge fs-6 rounded-pill" id="student-plan-status" style="padding: .5em .9em;"></span>
                                </div>
                                <div class="mb-3">
                                    <small class="opacity-75">PERIODO DE VIGENCIA</small>
                                    <p class="fs-5 mb-0" id="student-plan-period"></p>
                                </div>
                                <hr class="opacity-50">
                                <h5 class="mb-3 opacity-75">BENEFICIOS</h5>
                                <ul id="student-plan-benefits" class="list-unstyled"></ul>
                            </div>
                        </div>
                        <div class="col-lg-7 mb-4">
                            <div class="card h-100">
                                <div class="card-header"><h5>Historial de Pagos</h5></div>
                                <div class="card-body table-responsive">
                                    <table class="table">
                                        <thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Monto</th><th>Estado</th><th class="text-end">Comprobante</th></tr></thead>
                                        <tbody><tr><td>01/10/2025</td><td>Membres√≠a Mensual Fit</td><td>${GymApp.formatCurrency(49990)}</td><td><span class="badge bg-success">Pagado</span></td><td class="text-end"><a href="#" class="btn btn-sm btn-outline-primary"><i class="fas fa-download me-1"></i></a></td></tr></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            },
            schedule: () => `<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-2"><div><h2 id="schedule-title">Agenda de Clases</h2><p class="text-muted mb-0">${GymApp.state.currentUser.role === 'student' ? 'Inscr√≠bete en tus clases favoritas.' : 'Administra el horario de clases grupales.'}</p></div><button id="add-class-btn" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Agendar Clase</button></div><div class="card"><div class="card-body p-lg-4 p-md-3 p-2"><div id="calendar"></div></div></div>`,
            facilities: () => `<div class="page-header"><h2><i class="fas fa-wrench me-2"></i>Gesti√≥n de Instalaciones</h2><p class="text-muted">Administra el estado y mantenimiento de los equipos del gimnasio.</p></div><div class="card"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"><div class="search-input-group flex-grow-1" style="max-width: 400px;"><i class="fas fa-search"></i><input type="text" class="form-control" placeholder="Buscar equipo..." onkeyup="GymApp.filterTable(this.value, 'facilities-grid')"></div><button class="btn btn-primary" onclick="GymApp.showEquipmentFormModal()"><i class="fas fa-plus me-2"></i>A√±adir Equipo</button></div></div></div><div id="facilities-grid" class="mt-4"></div>`,
            'attendance-log': () => `<div class="page-header"><h2><i class="fas fa-clipboard-list me-2"></i>Registro de Asistencia</h2><p class="text-muted">Consulta el historial de ingresos de los socios al gimnasio.</p></div><div class="card"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"><div class="search-input-group flex-grow-1" style="max-width: 400px;"><i class="fas fa-search"></i><input type="text" class="form-control" placeholder="Buscar socio..." onkeyup="GymApp.filterTable(this.value, 'attendance-table-body')"></div></div><div class="table-responsive"><table class="table table-hover align-middle"><thead><tr><th>Socio</th><th>Fecha</th><th>Hora de Entrada</th></tr></thead><tbody id="attendance-table-body"></tbody></table></div></div></div>`,
            inventory: () => `<div class="page-header"><h2><i class="fas fa-boxes me-2"></i>Gesti√≥n de Inventario</h2><p class="text-muted">Controla el stock y los precios de los productos en venta.</p></div><div class="card"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"><div class="search-input-group flex-grow-1" style="max-width: 400px;"><i class="fas fa-search"></i><input type="text" class="form-control" placeholder="Buscar producto..." onkeyup="GymApp.filterTable(this.value, 'inventory-table-body')"></div><div class="btn-group"><button class="btn btn-primary" onclick="GymApp.showProductFormModal()"><i class="fas fa-plus me-2"></i>A√±adir</button><button class="btn btn-outline-secondary" onclick="GymApp.exportInventory()"><i class="fas fa-download me-2"></i>Exportar CSV</button></div></div><div class="table-responsive"><table class="table table-hover align-middle"><thead><tr><th>SKU</th><th>Producto</th><th>Stock</th><th>Precio</th><th class="text-end">Acciones</th></tr></thead><tbody id="inventory-table-body"></tbody></table></div></div></div>`,
            profile: () => {
                const user = GymApp.state.currentUser;
                const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                return `<div class="page-header"><h2>Mi Perfil</h2><p class="text-muted">Actualiza tu informaci√≥n personal y de contacto.</p></div>
                <div class="card">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-lg-4 text-center mb-4 mb-lg-0">
                                <div class="profile-avatar" style="width:150px;height:150px;font-size:4rem;margin:0 auto;border-width:4px;">${initials}</div>
                                <button class="btn btn-secondary mt-3" onclick="GymApp.showToast('Info','Funci√≥n no implementada.')"><i class="fas fa-camera me-2"></i>Cambiar Foto</button>
                            </div>
                            <div class="col-lg-8">
                                <form id="profile-form" onsubmit="GymApp.handleProfileUpdate(event)">
                                    <h5 class="card-title mb-3">Datos Personales</h5>
                                    <div class="mb-3">
                                        <label class="form-label">Nombre Completo</label>
                                        <input type="text" id="profile-input-name" class="form-control" value="${user.name}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" id="profile-input-email" class="form-control" value="${user.profile.email}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Tel√©fono</label>
                                        <input type="tel" id="profile-input-phone" class="form-control" value="${user.profile.phone || ''}" required>
                                    </div>
                                    <hr class="my-4">
                                    <h5 class="card-title mb-3">Cambiar Contrase√±a</h5>
                                    <p class="text-muted small">Deja estos campos en blanco si no deseas cambiar tu contrase√±a.</p>
                                    <div class="mb-3">
                                        <label class="form-label">Nueva Contrase√±a</label>
                                        <input type="password" id="profile-input-new-password" class="form-control" autocomplete="new-password">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Confirmar Nueva Contrase√±a</label>
                                        <input type="password" id="profile-input-confirm-password" class="form-control" autocomplete="new-password">
                                    </div>
                                    <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-save me-2"></i>Guardar Cambios</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>`;
            },
            'routine-builder': () => `<div class="page-header"><h2><i class="fas fa-dumbbell me-2"></i>Constructor de Rutinas</h2><p class="text-muted">Dise√±a y asigna planes de entrenamiento personalizados para tus alumnos.</p></div><div class="row"><div class="col-md-4 mb-4"><div class="card h-100"><div class="card-header"><h5>Mis Alumnos</h5></div><div id="professor-student-list" class="list-group list-group-flush"></div></div></div><div class="col-md-8 mb-4"><div class="card h-100"><div class="card-header" id="routine-builder-header"><h5>Selecciona un alumno</h5></div><div class="card-body" id="routine-builder-body"><p class="text-muted text-center p-5"><i class="fas fa-arrow-left fa-2x mb-2"></i><br>Elige un alumno de la lista para ver y editar su rutina.</p></div></div></div></div>`,
            'manage-students': () => `<div class="page-header"><h2><i class="fas fa-users-cog me-2"></i>Gestionar Alumnos</h2><p class="text-muted">Asigna alumnos a tu cargo y revisa la lista de alumnos sin profesor.</p></div><nav><div class="nav nav-tabs mb-3" id="nav-tab" role="tablist"><button class="nav-link active" id="nav-my-students-tab" data-bs-toggle="tab" data-bs-target="#nav-my-students" type="button">Mis Alumnos</button><button class="nav-link" id="nav-unassigned-tab" data-bs-toggle="tab" data-bs-target="#nav-unassigned" type="button">Alumnos sin Asignar</button></div></nav><div class="tab-content" id="nav-tabContent"><div class="tab-pane fade show active" id="nav-my-students"><div class="card"><div class="card-body"><div class="search-input-group mb-3"><i class="fas fa-search"></i><input type="text" class="form-control" placeholder="Buscar en mis alumnos..." onkeyup="GymApp.filterTable(this.value, 'my-students-grid')"></div><div id="my-students-grid"></div></div></div></div><div class="tab-pane fade" id="nav-unassigned"><div class="card"><div class="card-body"><div id="unassigned-students-grid"></div></div></div></div></div>`,
            evaluations: () => `<div class="page-header"><h2><i class="fas fa-clipboard-list me-2"></i>Evaluaciones F√≠sicas</h2><p class="text-muted">Registra y consulta el progreso f√≠sico y m√©tricas de tus alumnos.</p></div><div class="card"><div class="card-body"><label class="form-label">Seleccionar Alumno</label><select id="evaluation-student-select" class="form-select mb-3" onchange="GymApp.renderEvaluationForStudent(this.value)"><option selected value="">Elige un alumno...</option>${Object.values(GymApp.state.data.users).filter(u => u.role === 'student' && u.professorId === GymApp.state.currentUser.id).map(m=>`<option value="${m.id}">${m.name}</option>`).join('')}</select><div id="evaluation-content"><p class="text-muted text-center p-5"><i class="fas fa-user-check fa-2x mb-2"></i><br>Selecciona un alumno para ver su historial o a√±adir una nueva evaluaci√≥n.</p></div></div></div>`,
            'my-routine': () => {
                const routine = GymApp.state.currentUser.routine;
                let trainingDays = 0, restDays = 0;
                if(routine) { Object.values(routine).forEach(day => { if (day.isRestDay) restDays++; else if (day.exercises && day.exercises.length > 0) trainingDays++; }); }
                return `<div class="page-header"><h2><i class="fas fa-dumbbell me-2"></i>Mi Rutina Semanal</h2><p class="text-muted">Organiza tus entrenamientos, a√±ade ejercicios y marca tus d√≠as de descanso.</p></div><div id="routine-cards-container"></div>`;
            },
            'my-progress': () => {
                const recommendationsHTML = GymApp.getHealthRecommendations();
                return `<div class="page-header"><h2><i class="fas fa-chart-line me-2"></i>Seguimiento F√≠sico</h2><p class="text-muted">Visualiza tu evoluci√≥n, define tus metas y registra tu progreso.</p></div>
                <div class="card mb-4"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-3"><h5><i class="fas fa-bullseye me-2 text-primary"></i>Mis Objetivos Actuales</h5><button class="btn btn-sm btn-outline-primary" onclick="GymApp.showGoalSettingModal()"><i class="fas fa-edit me-1"></i>Definir/Editar Objetivos</button></div><div id="goal-progress-container" class="row g-3"></div></div></div>
                ${recommendationsHTML}
                <div class="row"><div class="col-12 mb-4"><div class="card"><div class="card-header"><h5>Registrar Nuevo Progreso</h5></div><div class="card-body"><form id="progress-form" onsubmit="GymApp.handleAddProgress(event)"><div class="row g-3"><div class="col-md-3 col-6"><label class="form-label">Peso (kg)</label><input type="number" step="0.1" class="form-control" id="progress-weight" required></div><div class="col-md-3 col-6"><label class="form-label">% Grasa</label><input type="number" step="0.1" class="form-control" id="progress-bodyfat"></div><div class="col-md-2 col-4"><label class="form-label">Pecho</label><input type="number" class="form-control" id="progress-chest"></div><div class="col-md-2 col-4"><label class="form-label">Cintura</label><input type="number" class="form-control" id="progress-waist"></div><div class="col-md-2 col-4"><label class="form-label">Cadera</label><input type="number" class="form-control" id="progress-hips"></div><div class="col-12 d-grid mt-3"><button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>A√±adir Registro</button></div></div></form></div></div></div><div class="col-lg-6 mb-4"><div class="card h-100"><div class="card-body"><h5 class="card-title">Peso y % Grasa Corporal</h5><div style="height:350px;"><canvas id="weightChart"></canvas></div></div></div></div><div class="col-lg-6 mb-4"><div class="card h-100"><div class="card-body"><h5 class="card-title">Medidas Corporales (cm)</h5><div style="height:350px;"><canvas id="measurementsChart"></canvas></div></div></div></div></div>`;
            },
            'my-classes': () => `
                <div class="page-header">
                    <h2><i class="fas fa-history me-2"></i>Mis Clases</h2>
                    <p class="text-muted">Administra tus clases inscritas y revisa tu historial de asistencia.</p>
                </div>
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header"><h5><i class="fas fa-calendar-check me-2 text-primary"></i>Pr√≥ximas Clases</h5></div>
                            <div id="upcoming-classes-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header"><h5><i class="fas fa-clipboard-check me-2 text-success"></i>Historial de Clases</h5></div>
                            <div id="past-classes-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                </div>`,
            'exercise-library': () => {
                const isProfessor = GymApp.state.currentUser.role === 'professor';
                const buttonHTML = isProfessor ? `<button class="btn btn-primary" onclick="GymApp.showExerciseFormModal()"><i class="fas fa-plus me-2"></i>Nuevo Ejercicio</button>` : '';
                return `
                <div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h2><i class="fas fa-book me-2"></i>Biblioteca de Ejercicios</h2>
                        <p class="text-muted mb-0">Explora, filtra y aprende la t√©cnica correcta para cada ejercicio.</p>
                    </div>
                    ${buttonHTML}
                </div>
                <div class="card">
                    <div class="card-body">
                        <div id="exercise-filters">
                            <div class="search-input-group">
                                <i class="fas fa-search"></i>
                                <input type="text" id="exercise-search" class="form-control" placeholder="Buscar por nombre...">
                            </div>
                            <select id="muscle-group-filter" class="form-select"></select>
                            <select id="equipment-filter" class="form-select"></select>
                            <button class="btn btn-secondary" onclick="GymApp.resetExerciseFilters()"><i class="fas fa-times me-2"></i>Reiniciar</button>
                        </div>
                    </div>
                </div>
                <div id="exercise-cards-container" class="mt-4"></div>`;
            }
        };

        Object.assign(GymApp, {
            templates: GymApp.templates,
            getUserPlanDetails(user) { if (!user.planId) { return { name: 'Sin Plan', status: 'Inactivo', startDate: 'N/A', endDate: 'N/A', benefits: [] }; } const plan = this.state.data.gymData.membershipPlans.find(p => p.id === user.planId); if (!plan) { return { name: 'Plan Desconocido', status: 'Error', startDate: 'N/A', endDate: 'N/A', benefits: [] }; } const startDate = new Date(user.membershipStartDate); const endDate = new Date(startDate); endDate.setDate(startDate.getDate() + plan.durationDays); const status = new Date() > endDate ? 'Vencido' : 'Activo'; return { ...plan, startDate: startDate.toLocaleDateString('es-CL'), endDate: endDate.toLocaleDateString('es-CL'), status }; },
            updateAdminCRMTable() {
                const tbody = document.getElementById('crm-table-body');
                if (tbody) {
                    tbody.innerHTML = Object.values(this.state.data.users).filter(u => u.role === 'student').map(m => {
                        const planDetails = this.getUserPlanDetails(m);
                        const professor = Object.values(this.state.data.users).find(u => u.id === m.professorId);
                        const phone = m.profile.phone || 'N/A';
                        const whatsappNumber = phone.startsWith('9') && phone.length === 9 ? `56${phone}` : phone.replace(/[^0-9]/g, '');
                        
                        return `
                            <tr data-name="${m.name.toLowerCase()}">
                                <td><strong>${m.name}</strong></td>
                                <td>
                                    <div>${m.profile.email}</div>
                                    <div>${phone}
                                        <a href="mailto:${m.profile.email}" class="btn btn-sm btn-link text-secondary p-0 ms-2" title="Enviar Email"><i class="fas fa-envelope"></i></a>
                                        <a href="https://wa.me/${whatsappNumber}" target="_blank" class="btn btn-sm btn-link text-success p-0 ms-1" title="Contactar por WhatsApp"><i class="fab fa-whatsapp"></i></a>
                                    </div>
                                </td>
                                <td>${planDetails.name}</td>
                                <td>${planDetails.startDate} - ${planDetails.endDate}</td>
                                <td><span class="badge ${planDetails.status === 'Activo' ? 'bg-success' : 'bg-danger'}">${planDetails.status}</span></td>
                                <td>${professor ? professor.name : 'Sin Asignar'}</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-primary" onclick="GymApp.showEditUserModal(${m.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>`;
                    }).join('');
                }
            },
            updateAdminPlansUI() {
                const container = document.getElementById('plans-container');
                if (container) {
                    container.innerHTML = this.state.data.gymData.membershipPlans.map(p => `
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card plan-card ${p.name.toLowerCase().includes('anual') ? 'is-recommended' : ''}">
                                <div class="card-header">
                                    <h4 class="my-0 fw-normal">${p.name}</h4>
                                </div>
                                <div class="card-body">
                                    <h3 class="price">${this.formatCurrency(p.price)}<span class="duration">/${p.durationDays > 31 ? 'a√±o' : 'mes'}</span></h3>
                                    <p class="text-muted mt-2">${p.description}</p>
                                    <ul class="benefits-list">
                                        ${p.benefits.map(b => `<li>${b}</li>`).join('')}
                                    </ul>
                                    <button class="btn btn-primary mt-auto" onclick="GymApp.showPlanFormModal(${p.id})">
                                        <i class="fas fa-edit me-2"></i>Editar Plan
                                    </button>
                                </div>
                            </div>
                        </div>`).join('');
                }
            },
            updateAdminInventoryTable() { const tbody = document.getElementById('inventory-table-body'); if(tbody) tbody.innerHTML = this.state.data.gymData.inventory.map(i=>`<tr data-name="${i.name.toLowerCase()}"><td>${i.sku}</td><td>${i.name}</td><td>${i.stock}</td><td>${this.formatCurrency(i.price)}</td><td class="text-end"><button class="btn btn-sm btn-info text-white" onclick="GymApp.showProductFormModal(${i.id})"><i class="fas fa-edit"></i></button></td></tr>`).join(''); },
            updateAdminPosItems() { const container = document.getElementById('pos-items'); if(container) container.innerHTML = this.state.data.gymData.inventory.map(item => `<a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="GymApp.addToCart(${item.id})"><span>${item.name} <small class="text-muted">(${item.stock} disp.)</small></span><span class="fw-bold text-primary">${this.formatCurrency(item.price)}</span></a>`).join(''); },
            updateCart() { const cartList = document.getElementById('pos-cart'), totalEl = document.getElementById('pos-total'); let total = 0; if (this.state.data.gymData.cart.length === 0) { cartList.innerHTML = '<li class="list-group-item text-center text-muted border-0">El carrito est√° vac√≠o.</li>'; } else { cartList.innerHTML = this.state.data.gymData.cart.map(item => { total += item.price * item.quantity; return `<li class="list-group-item d-flex justify-content-between align-items-center"><div><div class="fw-bold">${item.name}</div><div class="d-flex align-items-center mt-1"><button class="btn btn-sm btn-outline-secondary" onclick="GymApp.updateCartQuantity(${item.id}, ${item.quantity - 1})">-</button><input type="number" value="${item.quantity}" class="form-control form-control-sm text-center mx-1" style="width: 50px;" onchange="GymApp.updateCartQuantity(${item.id}, this.value)" min="1"><button class="btn btn-sm btn-outline-secondary" onclick="GymApp.updateCartQuantity(${item.id}, ${item.quantity + 1})">+</button></div></div><div class="text-end"><span>${this.formatCurrency(item.price * item.quantity)}</span><button class="btn btn-sm btn-link text-danger p-0 ms-2" onclick="GymApp.removeFromCart(${item.id})"><i class="fas fa-trash"></i></button></div></li>`; }).join(''); } totalEl.innerText = this.formatCurrency(total); },
            addToCart(itemId) { const item = this.state.data.gymData.inventory.find(i => i.id === itemId); if (item && item.stock > 0) { const cartItem = this.state.data.gymData.cart.find(c => c.id === itemId); if (cartItem) {if(item.stock > cartItem.quantity) cartItem.quantity++; else this.showToast('Stock insuficiente', '', 'warning');} else { this.state.data.gymData.cart.push({ ...item, quantity: 1 }); } this.updateCart(); } else { this.showToast('Sin Stock', 'Este producto no est√° disponible.', 'error'); }},
            updateCartQuantity(itemId, newQuantity) { newQuantity = parseInt(newQuantity); const cartItemIndex = this.state.data.gymData.cart.findIndex(c => c.id === itemId); if (cartItemIndex === -1) return; if (newQuantity < 1) { this.state.data.gymData.cart.splice(cartItemIndex, 1); } else { const inventoryItem = this.state.data.gymData.inventory.find(i => i.id === itemId); if (newQuantity > inventoryItem.stock) { this.showToast('Stock insuficiente', `Solo hay ${inventoryItem.stock} unidades disponibles.`, 'warning'); this.state.data.gymData.cart[cartItemIndex].quantity = inventoryItem.stock; } else { this.state.data.gymData.cart[cartItemIndex].quantity = newQuantity; } } this.updateCart(); },
            removeFromCart(itemId) { this.state.data.gymData.cart = this.state.data.gymData.cart.filter(c => c.id !== itemId); this.updateCart(); },
            processPayment() { if (this.state.data.gymData.cart.length > 0) { const cartData = [...this.state.data.gymData.cart]; const total = document.getElementById('pos-total').innerText; this.state.data.gymData.cart.forEach(cartItem => { const inventoryItem = this.state.data.gymData.inventory.find(invItem => invItem.id === cartItem.id); if(inventoryItem) inventoryItem.stock -= cartItem.quantity; }); this.showReceiptModal(cartData, total); this.state.data.gymData.cart = []; this.updateCart(); this.saveState(); } else { this.showToast('Carrito Vac√≠o', 'Agrega productos al carrito.', 'warning'); } },
            showReceiptModal(cartItems, total) { const isDark = this.state.currentTheme === 'dark'; const itemsHTML = cartItems.map(item => `<tr><td>${item.name} (x${item.quantity})</td><td style="text-align: right;">${this.formatCurrency(item.price * item.quantity)}</td></tr>`).join(''); const receiptHTML = `<style>#receipt-container{font-family: 'Courier New', monospace; color: ${isDark ? '#fff' : '#000'};} #receipt-container hr {border-top: 1px dashed ${isDark ? '#555' : '#000'};} .receipt-header {text-align:center; margin-bottom: 20px;} .receipt-table {width: 100%;} .receipt-total {font-weight: bold;}</style><div id="receipt-container"><div class="receipt-header"><h3>GymApp Pro</h3><p>Boleta de Venta</p><p>${new Date().toLocaleString('es-CL')}</p></div><hr><table class="receipt-table"><thead><tr><th>Producto</th><th style="text-align: right;">Precio</th></tr></thead><tbody>${itemsHTML}</tbody></table><hr><table class="receipt-table"><tr class="receipt-total"><td><strong>TOTAL</strong></td><td style="text-align: right;"><strong>${total}</strong></td></tr></table><hr><p style="text-align:center; font-size: 0.8em;">¬°Gracias por tu compra!</p></div>`; Swal.fire({ title: 'Pago Procesado', html: receiptHTML, confirmButtonText: '<i class="fas fa-print"></i> Imprimir', showCancelButton: true, cancelButtonText: 'Cerrar', width: '380px', customClass: { popup: isDark ? 'dark-mode' : '' } }).then((result) => { if (result.isConfirmed) { const receiptWindow = window.open('', 'PRINT', 'height=600,width=800'); receiptWindow.document.write(`<html><head><title>Boleta</title>`); receiptWindow.document.write('</head><body >'); receiptWindow.document.write(receiptHTML); receiptWindow.document.write('</body></html>'); receiptWindow.document.close(); receiptWindow.focus(); receiptWindow.print(); receiptWindow.close(); } }); },
            updateStudentPlanUI() { const planDetails = this.getUserPlanDetails(this.state.currentUser); const nameEl = document.getElementById('student-plan-name'); const statusEl = document.getElementById('student-plan-status'); const periodEl = document.getElementById('student-plan-period'); const benefitsEl = document.getElementById('student-plan-benefits'); if (nameEl && statusEl && periodEl && benefitsEl) { nameEl.innerText = planDetails.name; statusEl.innerText = planDetails.status; statusEl.className = `badge fs-6 rounded-pill ${planDetails.status === 'Activo' ? 'bg-success-subtle text-success-emphasis' : 'bg-danger-subtle text-danger-emphasis'}`; periodEl.innerText = `${planDetails.startDate} - ${planDetails.endDate}`; benefitsEl.innerHTML = planDetails.benefits.map(b => `<li class="mb-2"><i class="fas fa-check-circle me-2 opacity-75"></i>${b}</li>`).join(''); } },
            updateStudentClassesHistory() {
                const upcomingList = document.getElementById('upcoming-classes-list');
                const pastList = document.getElementById('past-classes-list');
                if (!upcomingList || !pastList) return;

                const now = new Date();
                const userClasses = this.state.data.gymData.classes.filter(c => c.reservedBy.includes(this.state.currentUser.id));
                
                const upcomingClasses = userClasses.filter(c => new Date(c.start) > now);
                const pastClasses = userClasses.filter(c => new Date(c.start) <= now).sort((a, b) => new Date(b.start) - new Date(a.start));

                if (upcomingClasses.length === 0) {
                    upcomingList.innerHTML = '<li class="list-group-item text-center text-muted">No tienes pr√≥ximas clases.</li>';
                } else {
                    upcomingList.innerHTML = upcomingClasses.map(c => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${c.title}</strong><br>
                                <small class="text-muted">${new Date(c.start).toLocaleString('es-CL',{weekday:'long',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'})}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="GymApp.handleClassReservation(${c.id})">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                        </li>`).join('');
                }

                if (pastClasses.length === 0) {
                    pastList.innerHTML = '<li class="list-group-item text-center text-muted">A√∫n no has asistido a ninguna clase.</li>';
                } else {
                    pastList.innerHTML = pastClasses.map(c => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${c.title}</strong><br>
                                <small class="text-muted">${new Date(c.start).toLocaleString('es-CL',{weekday:'long',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'})}</small>
                            </div>
                            <span class="badge bg-success-subtle text-success-emphasis">Asistida</span>
                        </li>`).join('');
                }
            },
            updateStudentCharts() { Object.values(this.charts).forEach(c => c.destroy()); const p=this.state.currentUser.progress; const d=this.state.currentTheme==='dark'; const g=d?'rgba(255,255,255,0.1)':'rgba(0,0,0,0.1)'; const t=d?'#DFE3FA':'#888EB0'; const o={responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{color:t},grid:{color:g}},y:{type:'linear',display:true,position:'left',ticks:{color:t},grid:{color:g}}},plugins:{legend:{labels:{color:t}}}}; const wC=document.getElementById('weightChart'); if(wC)this.charts.weight=new Chart(wC.getContext('2d'),{type:'line',data:{labels:p.labels,datasets:[{label:'Peso (kg)',data:p.weights,borderColor:'var(--primary-color)',yAxisID:'y'},{label:'% Grasa',data:p.bodyFat,borderColor:'var(--danger-color)',yAxisID:'y1'}]},options:{...o,scales:{...o.scales,y1:{type:'linear',display:true,position:'right',grid:{drawOnChartArea:false},ticks:{color:t}}}}}); const mC=document.getElementById('measurementsChart'); if(mC)this.charts.measurements=new Chart(mC.getContext('2d'),{type:'line',data:{labels:p.labels,datasets:[{label:'Pecho (cm)',data:p.measurements.chest,borderColor:'var(--success-color)'},{label:'Cintura (cm)',data:p.measurements.waist,borderColor:'var(--warning-color)'},{label:'Cadera (cm)',data:p.measurements.hips,borderColor:'var(--info-color)'}]},options:o}); },
            updateManageStudentsUI() { const myStudentsGrid = document.getElementById('my-students-grid'); const unassignedGrid = document.getElementById('unassigned-students-grid'); const students = Object.values(this.state.data.users).filter(u => u.role === 'student'); const myStudents = students.filter(s => s.professorId === this.state.currentUser.id); const unassignedStudents = students.filter(s => !s.professorId); const createStudentCard = (s, isMyStudent) => { const plan = this.getUserPlanDetails(s); const initials = s.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase(); const phone = s.profile.phone || ''; const whatsappNumber = phone.startsWith('9') && phone.length === 9 ? `56${phone}` : phone.replace(/[^0-9]/g, ''); return `<div class="card student-card" data-name="${s.name.toLowerCase()}"><div class="card-body"><div class="d-flex align-items-center gap-3 mb-3"><div class="student-card-avatar">${initials}</div><div><h5 class="mb-0">${s.name}</h5><small class="text-muted">${s.profile.email}</small></div></div><div class="d-flex justify-content-between text-center small mb-3"><div class="w-50"><strong>Plan:</strong><br>${plan.name}</div><div class="w-50 border-start"><strong>Estado:</strong><br><span class="badge ${plan.status === 'Activo' ? 'bg-success' : 'bg-danger'}">${plan.status}</span></div></div><div class="d-flex gap-2">${isMyStudent ? `<button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="GymApp.navigateTo('routine-builder'); setTimeout(() => GymApp.loadRoutineForStudent(${s.id}, document.querySelector('#professor-student-list [data-student-id=\\'${s.id}\\']')), 50);">Rutina</button><button class="btn btn-sm btn-outline-info" title="Chatear con ${s.name}" onclick="GymApp.openChatWithStudent(${s.id})"><i class="fas fa-comments"></i></button><a href="mailto:${s.profile.email}" class="btn btn-sm btn-outline-secondary" title="Enviar Email"><i class="fas fa-envelope"></i></a><a href="https://wa.me/${whatsappNumber}" target="_blank" class="btn btn-sm btn-outline-success" title="Contactar por WhatsApp"><i class="fab fa-whatsapp"></i></a>` : `<button class="btn btn-sm btn-success w-100" onclick="GymApp.claimStudent(${s.id})"><i class="fas fa-plus me-1"></i> Asignarme Alumno</button>`}</div></div></div>`; }; if(myStudents.length > 0) { myStudentsGrid.innerHTML = `<div id="students-grid">${myStudents.map(s => createStudentCard(s, true)).join('')}</div>`; } else { myStudentsGrid.innerHTML = `<p class="text-muted text-center p-4">No tienes alumnos asignados.</p>`; } if(unassignedStudents.length > 0) { unassignedGrid.innerHTML = `<div id="students-grid">${unassignedStudents.map(s => createStudentCard(s, false)).join('')}</div>`; } else { unassignedGrid.innerHTML = `<p class="text-muted text-center p-4">No hay alumnos sin asignar.</p>`; } },
            claimStudent(studentId) { const student = Object.values(this.state.data.users).find(u=>u.id === studentId); if(student) { student.professorId = this.state.currentUser.id; this.saveState(); this.showToast('¬°√âxito!', `${student.name} ha sido asignado a tu lista.`, 'success'); this.updateManageStudentsUI(); } },
            
            initializeCalendar(role) {
                if (this.calendar) this.calendar.destroy();
                const el = document.getElementById('calendar');
                if (!el) return;

                const isMobile = window.innerWidth < 768;

                this.calendar = new FullCalendar.Calendar(el, {
                    initialView: 'dayGridMonth',
                    locale: 'es',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,listWeek'
                    },
                    height: 'auto',
                    dayMaxEvents: true,
                    titleFormat: isMobile ? { month: 'short', year: 'numeric' } : { month: 'long', year: 'numeric' },
                    dayHeaderFormat: isMobile ? { weekday: 'narrow' } : { weekday: 'short' },
                    
                    events: (fetchInfo, successCallback, failureCallback) => {
                        const eventData = this.state.data.gymData.classes.map(c => ({
                            id: c.id,
                            title: c.title,
                            start: c.start,
                            extendedProps: { classData: c },
                            backgroundColor: c.teacher === 'Carlos Rivas' ? 'var(--primary-color)' : 'var(--info-color)',
                            borderColor: c.teacher === 'Carlos Rivas' ? 'var(--primary-color)' : 'var(--info-color)',
                        }));
                        successCallback(eventData);
                    },
                    eventClick: (info) => {
                        const d = info.event.extendedProps.classData;
                        if (role === 'admin' || role === 'professor') {
                            this.showClassFormModal(d.id);
                        } else {
                            const r = d.reservedBy.includes(this.state.currentUser.id);
                            const f = d.reservedBy.length >= d.spots;
                            Swal.fire({
                                title: d.title,
                                html: `<p><strong>Profesor:</strong> ${d.teacher}</p><p><strong>Cupos:</strong> ${d.reservedBy.length} / ${d.spots}</p>`,
                                icon: 'info',
                                showCancelButton: true,
                                confirmButtonText: r ? 'Cancelar Reserva' : (f ? 'Clase Llena' : 'Inscribirme'),
                                confirmButtonColor: r ? 'var(--danger-color)' : 'var(--success-color)',
                                cancelButtonText: 'Cerrar',
                                preConfirm: () => this.handleClassReservation(d.id),
                                allowOutsideClick: () => !Swal.isLoading()
                            });
                        }
                    }
                });
                this.calendar.render();
            },

            handleClassReservation(id) {const c=this.state.data.gymData.classes.find(c=>c.id===id);const s=this.state.currentUser.id;const i=c.reservedBy.indexOf(s);if(i>-1){c.reservedBy.splice(i,1);this.showToast('Reserva Cancelada',`Cancelaste tu reserva para ${c.title}.`);}else if(c.reservedBy.length<c.spots){c.reservedBy.push(s);this.showToast('¬°Inscrito!',`Te inscribiste a ${c.title}.`);}else{this.showToast('Error','Clase llena.','error');} if(this.calendar) this.calendar.refetchEvents(); this.updateStudentClassesHistory(); if(document.querySelector('.page-header h2').innerText === 'Mi Dashboard') { this.navigateTo('dashboard'); } this.saveState(); },
            handleAddProgress(e) { e.preventDefault(); const p=this.state.currentUser.progress;p.labels.push(new Date().toLocaleString('es-ES',{month:'long'}));p.weights.push(parseFloat(document.getElementById('progress-weight').value)||p.weights.slice(-1)[0]);p.bodyFat.push(parseFloat(document.getElementById('progress-bodyfat').value)||p.bodyFat.slice(-1)[0]);p.measurements.chest.push(parseFloat(document.getElementById('progress-chest').value)||p.measurements.chest.slice(-1)[0]);p.measurements.waist.push(parseFloat(document.getElementById('progress-waist').value)||p.measurements.waist.slice(-1)[0]);p.measurements.hips.push(parseFloat(document.getElementById('progress-hips').value)||p.measurements.hips.slice(-1)[0]);this.updateStudentCharts();this.updateStudentGoalsUI();this.showToast('Progreso Guardado','Tu nuevo registro ha sido a√±adido.');this.saveState();e.target.reset(); },
            handleProfileUpdate(event) {
                event.preventDefault();
                const user = this.state.currentUser;
                const newPassword = document.getElementById('profile-input-new-password').value;
                const confirmPassword = document.getElementById('profile-input-confirm-password').value;
                user.name = document.getElementById('profile-input-name').value;
                user.profile.email = document.getElementById('profile-input-email').value;
                user.profile.phone = document.getElementById('profile-input-phone').value;
                if (newPassword || confirmPassword) {
                    if (newPassword !== confirmPassword) {
                        this.showToast('Error de Contrase√±a', 'Las nuevas contrase√±as no coinciden.', 'error');
                        return;
                    }
                    if (newPassword.length < 4) {
                        this.showToast('Contrase√±a Insegura', 'La nueva contrase√±a debe tener al menos 4 caracteres.', 'warning');
                        return;
                    }
                    user.password = newPassword;
                    this.showToast('Perfil Actualizado', 'Tus datos y contrase√±a han sido guardados.', 'success');
                } else {
                    this.showToast('Perfil Actualizado', 'Tus datos han sido guardados.', 'success');
                }
                document.getElementById('profile-input-new-password').value = '';
                document.getElementById('profile-input-confirm-password').value = '';
                this.setupUIForRole();
                this.saveState();
            },
            toggleCompletionForToday(day) { const routineDay = this.state.currentUser.routine[day]; const todayISO = new Date().toISOString().split('T')[0]; const index = routineDay.completionHistory.indexOf(todayISO); if (index > -1) { routineDay.completionHistory.splice(index, 1); this.showToast('Progreso desmarcado', `El d√≠a de hoy ya no est√° marcado.`); } else { routineDay.completionHistory.push(todayISO); this.showToast('¬°Felicidades!', `Has completado la rutina de hoy.`, 'success'); } this.saveState(); this.updateStudentRoutineUI(); },
            toggleRestDay(day, studentId) { 
                const user = Object.values(this.state.data.users).find(u => u.id === studentId); 
                if (!user) return; 
                if (!user.routine[day]) user.routine[day] = { exercises: [], completionHistory: [], isRestDay: false }; 
                user.routine[day].isRestDay = !user.routine[day].isRestDay; 
                if (user.routine[day].isRestDay) { user.routine[day].exercises = []; } 
                this.saveState(); 
                this.updateStudentRoutineUI(studentId);
            },
            deleteExercise(day, exerciseId, studentId) { Swal.fire({title:'¬øEst√°s seguro?',text:"No podr√°s revertir esto.",icon:'warning',showCancelButton:true,confirmButtonText:'S√≠, eliminar',cancelButtonText:'Cancelar'}).then(r=>{if(r.isConfirmed){const user=Object.values(this.state.data.users).find(u=>u.id===studentId);if(user&&user.routine[day]){user.routine[day].exercises=user.routine[day].exercises.filter(e=>e.id!==exerciseId);this.showToast('Eliminado','El ejercicio ha sido eliminado.','success');this.saveState(); this.updateStudentRoutineUI(studentId);}}}); },
            handleExerciseFormSubmit(event, day, routineExerciseId, studentId) { event.preventDefault(); const user = Object.values(this.state.data.users).find(u => u.id === studentId); if (!user) return; const form = event.target; const exerciseData = { exerciseId: parseInt(form.elements.exerciseId.value), weight: form.elements.exerciseWeight.value || 'N/A', series: form.elements.exerciseSeries.value || 'N/A', reps: form.elements.exerciseReps.value || 'N/A' }; if (routineExerciseId) { const exercise = user.routine[day].exercises.find(ex => ex.id === routineExerciseId); if (exercise) Object.assign(exercise, exerciseData); } else { exerciseData.id = Date.now(); if (!user.routine[day]) user.routine[day] = { exercises: [], completionHistory:[], isRestDay: false }; user.routine[day].exercises.push(exerciseData); } this.showToast('√âxito', `Ejercicio ${routineExerciseId ? 'actualizado' : 'a√±adido'}.`, 'success'); this.mainModal.hide(); this.saveState(); this.updateStudentRoutineUI(studentId); },
            showEditExerciseModal(day, routineExerciseId = null, studentId = null) {
                const isEdit = routineExerciseId !== null;
                const user = Object.values(this.state.data.users).find(u => u.id === studentId);
                if (!user) return;
                const routineExercise = isEdit ? user.routine[day].exercises.find(ex => ex.id === routineExerciseId) : {};
                
                const exerciseOptions = this.state.data.gymData.exerciseLibrary.map(ex => 
                    `<option value="${ex.id}" ${isEdit && ex.id === routineExercise.exerciseId ? 'selected' : ''}>${ex.name}</option>`
                ).join('');

                document.getElementById('mainModalTitle').innerText = isEdit ? `Editar Ejercicio` : `A√±adir Ejercicio a ${day}`;
                document.getElementById('mainModalBody').innerHTML = `
                    <form id="exerciseForm">
                        <div class="mb-3">
                            <label class="form-label">Nombre del Ejercicio</label>
                            <select name="exerciseId" class="form-select" required>${exerciseOptions}</select>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3"><label class="form-label">Peso</label><input type="text" name="exerciseWeight" class="form-control" value="${isEdit ? (routineExercise.weight || '') : ''}"></div>
                            <div class="col-md-4 mb-3"><label class="form-label">Series</label><input type="number" name="exerciseSeries" class="form-control" value="${isEdit ? (routineExercise.series || '') : ''}"></div>
                            <div class="col-md-4 mb-3"><label class="form-label">Repeticiones</label><input type="text" name="exerciseReps" class="form-control" value="${isEdit ? (routineExercise.reps || '') : ''}"></div>
                        </div>
                    </form>`;
                document.getElementById('mainModalFooter').innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="exerciseForm" class="btn btn-primary">Guardar Cambios</button>`;
                document.getElementById('exerciseForm').onsubmit = (event) => this.handleExerciseFormSubmit(event, day, routineExerciseId, studentId);
                this.mainModal.show();
            },
            calculatePeakHours() { const hourlyCounts = Array(24).fill(0); this.state.data.gymData.attendanceLog.forEach(log => { const hour = new Date(log.timestamp).getHours(); hourlyCounts[hour]++; }); const labels = Array.from({length: 15}, (_, i) => i + 6).map(h => `${h}:00`); const data = hourlyCounts.slice(6, 21); return { labels, data }; },
            renderAdminCharts() { Object.values(this.charts).forEach(c => c.destroy()); const isDark = this.state.currentTheme === 'dark'; const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'; const textColor = isDark ? '#DFE3FA' : '#888EB0'; const peakHoursData = this.calculatePeakHours(); const peakHoursCtx = document.getElementById('peakHoursChart')?.getContext('2d'); if(peakHoursCtx) this.charts.peakHours = new Chart(peakHoursCtx, { type: 'bar', data: { labels: peakHoursData.labels, datasets: [{ label: 'N¬∫ de Asistencias', data: peakHoursData.data, backgroundColor: 'rgba(124, 93, 255, 0.6)', borderColor: 'var(--primary-color)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: textColor, stepSize: 1 }, grid: { color: gridColor } }, x: { ticks: { color: textColor }, grid: { color: gridColor } } }, plugins: { legend: { display: false } } } }); },
            exportToCSV(data, filename = 'export.csv') { const headers = Object.keys(data[0]); const csvRows = [headers.join(',')]; for (const row of data) { const values = headers.map(header => { const escaped = (''+row[header]).replace(/"/g, '\\"'); return `"${escaped}"`; }); csvRows.push(values.join(',')); } const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' }); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.setAttribute('hidden', ''); a.setAttribute('href', url); a.setAttribute('download', filename); document.body.appendChild(a); a.click(); document.body.removeChild(a); },
            exportCRM() { const members = Object.values(this.state.data.users).filter(u => u.role === 'student').map(user => { const planDetails = this.getUserPlanDetails(user); const professor = Object.values(this.state.data.users).find(u=> u.id === user.professorId); return { id: user.id, nombre: user.name, email: user.profile.email, telefono: user.profile.phone || 'N/A', plan: planDetails.name, estado_membresia: planDetails.status, fecha_fin: planDetails.endDate, profesor: professor ? professor.name : 'Sin Asignar' }; }); this.exportToCSV(members, 'socios_gymapp.csv'); },
            showCreateUserModal() {
                const plans = this.state.data.gymData.membershipPlans.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                const professors = Object.values(this.state.data.users).filter(u => u.role === 'professor').map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                document.getElementById('mainModalTitle').innerText = 'Crear Nuevo Socio';
                document.getElementById('mainModalBody').innerHTML = `
                    <form id="userForm">
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Nombre Completo</label><input type="text" name="userName" class="form-control" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Email</label><input type="email" name="userEmail" class="form-control" required></div>
                        </div>
                        <div class="row">
                             <div class="col-md-6 mb-3"><label class="form-label">N√∫mero de Tel√©fono</label><input type="tel" name="userPhone" class="form-control" placeholder="Ej: 912345678" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Contrase√±a</label><input type="password" name="userPassword" class="form-control" required></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Asignar Plan</label><select name="planId" class="form-select">${plans}</select></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Asignar Profesor</label><select name="professorId" class="form-select"><option value="">Sin Asignar</option>${professors}</select></div>
                        </div>
                    </form>`;
                document.getElementById('mainModalFooter').innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="userForm" class="btn btn-primary">Crear Socio</button>`;
                document.getElementById('userForm').onsubmit = (event) => this.handleUserFormSubmit(event);
                this.mainModal.show();
            },
            showEditUserModal(userId) {
                const user = Object.values(this.state.data.users).find(u => u.id === userId);
                if (!user) return;
                const plans = this.state.data.gymData.membershipPlans.map(p => `<option value="${p.id}" ${p.id === user.planId ? 'selected' : ''}>${p.name}</option>`).join('');
                const professors = Object.values(this.state.data.users).filter(u => u.role === 'professor').map(p => `<option value="${p.id}" ${p.id === user.professorId ? 'selected' : ''}>${p.name}</option>`).join('');
                document.getElementById('mainModalTitle').innerText = `Editando a ${user.name}`;
                document.getElementById('mainModalBody').innerHTML = `
                    <form id="userForm">
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Nombre Completo</label><input type="text" name="userName" class="form-control" value="${user.name}" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Email</label><input type="email" name="userEmail" class="form-control" value="${user.profile.email}" required></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">N√∫mero de Tel√©fono</label><input type="tel" name="userPhone" class="form-control" value="${user.profile.phone || ''}" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Asignar Plan</label><select name="planId" class="form-select">${plans}</select></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Asignar Profesor</label><select name="professorId" class="form-select"><option value="">Sin Asignar</option>${professors}</select></div>
                    </form>`;
                document.getElementById('mainModalFooter').innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="userForm" class="btn btn-primary">Guardar Cambios</button>`;
                document.getElementById('userForm').onsubmit = (event) => this.handleUserFormSubmit(event, userId);
                this.mainModal.show();
            },
            handleUserFormSubmit(event, userId = null) {
                event.preventDefault();
                const form = event.target;
                if (userId) {
                    const user = Object.values(this.state.data.users).find(u => u.id === userId);
                    if (user) {
                        user.name = form.elements.userName.value;
                        user.profile.email = form.elements.userEmail.value;
                        user.profile.phone = form.elements.userPhone.value;
                        user.planId = parseInt(form.elements.planId.value);
                        user.professorId = form.elements.professorId.value ? parseInt(form.elements.professorId.value) : null;
                        this.showToast('√âxito', 'Socio actualizado.', 'success');
                    }
                } else {
                    const newId = Date.now();
                    const newUser = {
                        id: newId,
                        role: 'student',
                        name: form.elements.userName.value,
                        profile: { email: form.elements.userEmail.value, phone: form.elements.userPhone.value },
                        password: form.elements.userPassword.value,
                        planId: parseInt(form.elements.planId.value),
                        membershipStartDate: new Date().toISOString().split('T')[0],
                        professorId: form.elements.professorId.value ? parseInt(form.elements.professorId.value) : null,
                        routine: { Lunes: {}, Martes: {}, Mi√©rcoles: {}, Jueves: {}, Viernes: {}, S√°bado: {}, Domingo: {} },
                        evaluations: [],
                        goals: {}
                    };
                    this.state.data.users[`user-${newId}`] = newUser;
                    this.showToast('√âxito', 'Nuevo socio creado.', 'success');
                }
                this.saveState();
                this.mainModal.hide();
                this.updateAdminCRMTable();
            },
            renderEvaluationForStudent(studentId) { const contentEl = document.getElementById('evaluation-content'); if (!studentId) { contentEl.innerHTML = '<p class="text-muted text-center p-5"><i class="fas fa-user-check fa-2x mb-2"></i><br>Selecciona un alumno para ver su historial o a√±adir una nueva evaluaci√≥n.</p>'; return; } const student = Object.values(this.state.data.users).find(u=>u.id === parseInt(studentId)); if (!student) return; let historyHTML = (student.evaluations && student.evaluations.length > 0) ? [...student.evaluations].reverse().map(ev => `<div class="card evaluation-history-card"><div class="card-body"><div class="d-flex justify-content-between align-items-start mb-3"><div><h5 class="card-title mb-0">Evaluaci√≥n del ${new Date(ev.date).toLocaleDateString('es-CL')}</h5></div></div><div class="evaluation-metrics mb-3"><div class="metric-item"><strong>${ev.weight}</strong><span>Peso (kg)</span></div><div class="metric-item"><strong>${ev.bodyFat}</strong><span>Grasa (%)</span></div><div class="metric-item"><strong>${ev.measurements.chest}</strong><span>Pecho (cm)</span></div><div class="metric-item"><strong>${ev.measurements.waist}</strong><span>Cintura (cm)</span></div><div class="metric-item"><strong>${ev.measurements.hips}</strong><span>Cadera (cm)</span></div></div>${ev.notes ? `<p class="mb-0 mt-3 p-2 rounded small" style="background-color: var(--primary-light);"><i class="fas fa-quote-left me-2"></i><i>${ev.notes}</i></p>`: ''}</div></div>`).join('') : '<p class="text-muted text-center p-4">No hay registros de evaluaci√≥n para este alumno.</p>'; contentEl.innerHTML = `<h4 class="mb-3">Evaluaci√≥n para <strong>${student.name}</strong></h4><div class="card mb-4"><div class="card-header"><h5>A√±adir Nueva Evaluaci√≥n</h5></div><div class="card-body"><form id="eval-form" onsubmit="GymApp.handleAddEvaluation(event, ${studentId})"><div class="row g-3"><div class="col-md-4"><label class="form-label">Peso (kg)</label><input name="eval-weight" type="number" step="0.1" class="form-control" required></div><div class="col-md-4"><label class="form-label">% Grasa</label><input name="eval-bodyfat" type="number" step="0.1" class="form-control" required></div><div class="col-md-4"><label class="form-label">Pecho (cm)</label><input name="eval-chest" type="number" step="0.1" class="form-control"></div><div class="col-md-4"><label class="form-label">Cintura (cm)</label><input name="eval-waist" type="number" step="0.1" class="form-control"></div><div class="col-md-4"><label class="form-label">Cadera (cm)</label><input name="eval-hips" type="number" step="0.1" class="form-control"></div><div class="col-12"><label class="form-label">Notas</label><textarea name="eval-notes" class="form-control" rows="2"></textarea></div><div class="col-12 d-grid"><button type="submit" class="btn btn-primary">A√±adir Registro</button></div></div></form></div></div><h5>Historial de Evaluaciones</h5><div id="evaluation-history-container">${historyHTML}</div>`; },
            handleAddEvaluation(event, studentId) { event.preventDefault(); const student = Object.values(this.state.data.users).find(u=>u.id === studentId); const form = event.target; const newEval = { date: new Date().toISOString().split('T')[0], weight: form.elements['eval-weight'].value, bodyFat: form.elements['eval-bodyfat'].value, notes: form.elements['eval-notes'].value, measurements: { chest: form.elements['eval-chest'].value, waist: form.elements['eval-waist'].value, hips: form.elements['eval-hips'].value } }; if (!student.evaluations) student.evaluations = []; student.evaluations.push(newEval); this.saveState(); this.showToast('Evaluaci√≥n A√±adida', `Nuevo registro guardado para ${student.name}.`); this.renderEvaluationForStudent(studentId); },
            showPlanFormModal(planId = null) { const isEdit = planId !== null; const plan = isEdit ? this.state.data.gymData.membershipPlans.find(p => p.id === planId) : {}; document.getElementById('mainModalTitle').innerText = isEdit ? `Editar Plan: ${plan.name}` : 'Crear Nuevo Plan'; document.getElementById('mainModalBody').innerHTML = `<form id="planForm"><div class="row"><div class="col-md-8 mb-3"><label class="form-label">Nombre del Plan</label><input type="text" name="planName" class="form-control" value="${isEdit ? plan.name : ''}" required></div><div class="col-md-4 mb-3"><label class="form-label">Precio (CLP)</label><input type="number" name="planPrice" step="10" class="form-control" value="${isEdit ? plan.price : ''}" required></div></div><div class="mb-3"><label class="form-label">Descripci√≥n</label><textarea name="planDescription" class="form-control" rows="2">${isEdit ? plan.description : ''}</textarea></div><div class="mb-3"><label class="form-label">Beneficios (uno por l√≠nea)</label><textarea name="planBenefits" class="form-control" rows="3">${isEdit ? plan.benefits.join('\n') : ''}</textarea></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Duraci√≥n (d√≠as)</label><input type="number" name="planDuration" class="form-control" value="${isEdit ? plan.durationDays : ''}" required></div><div class="col-md-6 mb-3 d-flex align-items-end"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="planFreeze" role="switch" ${isEdit && plan.rules.allowFreeze ? 'checked' : ''}><label class="form-check-label">Permitir congelaci√≥n</label></div></div></div></form>`; document.getElementById('mainModalFooter').innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="planForm" class="btn btn-primary">Guardar</button>`; document.getElementById('planForm').onsubmit = (event) => this.handlePlanFormSubmit(event, planId); this.mainModal.show(); },
            handlePlanFormSubmit(event, planId = null) { event.preventDefault(); const form = event.target; const benefits = form.elements.planBenefits.value.split('\n').filter(b => b.trim() !== ''); if (planId) { const plan = this.state.data.gymData.membershipPlans.find(p => p.id === planId); if (plan) { Object.assign(plan, { name: form.elements.planName.value, price: parseFloat(form.elements.planPrice.value), description: form.elements.planDescription.value, benefits, durationDays: parseInt(form.elements.planDuration.value), rules: { allowFreeze: form.elements.planFreeze.checked } }); this.showToast('√âxito', 'Plan actualizado.', 'success'); } } else { const newId = Date.now(); const newPlan = { id: newId, name: form.elements.planName.value, price: parseFloat(form.elements.planPrice.value), description: form.elements.planDescription.value, benefits, durationDays: parseInt(form.elements.planDuration.value), rules: { allowFreeze: form.elements.planFreeze.checked } }; this.state.data.gymData.membershipPlans.push(newPlan); this.showToast('√âxito', 'Nuevo plan creado.', 'success'); } this.saveState(); this.mainModal.hide(); this.updateAdminPlansUI(); },
            showProductFormModal(productId = null) { const isEdit = productId !== null; const product = isEdit ? this.state.data.gymData.inventory.find(p => p.id === productId) : {}; document.getElementById('mainModalTitle').innerText = isEdit ? `Editar Producto: ${product.name}` : 'A√±adir Nuevo Producto'; document.getElementById('mainModalBody').innerHTML = `<form id="productForm"><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Nombre del Producto</label><input type="text" name="productName" class="form-control" value="${isEdit ? product.name : ''}" required></div><div class="col-md-6 mb-3"><label class="form-label">SKU</label><input type="text" name="productSku" class="form-control" value="${isEdit ? product.sku : ''}" required></div></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Stock</label><input type="number" name="productStock" class="form-control" value="${isEdit ? product.stock : ''}" required></div><div class="col-md-6 mb-3"><label class="form-label">Precio (CLP)</label><input type="number" name="productPrice" step="10" class="form-control" value="${isEdit ? product.price : ''}" required></div></div></form>`; document.getElementById('mainModalFooter').innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="productForm" class="btn btn-primary">Guardar</button>`; document.getElementById('productForm').onsubmit = (event) => this.handleProductFormSubmit(event, productId); this.mainModal.show(); },
            handleProductFormSubmit(event, productId = null) { event.preventDefault(); const form = event.target; if (productId) { const product = this.state.data.gymData.inventory.find(p => p.id === productId); if (product) { Object.assign(product, { name: form.elements.productName.value, sku: form.elements.productSku.value, stock: parseInt(form.elements.productStock.value), price: parseFloat(form.elements.productPrice.value) }); this.showToast('√âxito', 'Producto actualizado.', 'success'); } } else { const newId = Date.now(); const newProduct = { id: newId, name: form.elements.productName.value, sku: form.elements.productSku.value, stock: parseInt(form.elements.productStock.value), price: parseFloat(form.elements.productPrice.value) }; this.state.data.gymData.inventory.push(newProduct); this.showToast('√âxito', 'Nuevo producto a√±adido.', 'success'); } this.saveState(); this.mainModal.hide(); this.updateAdminInventoryTable(); },
            showClassFormModal(classId = null) { const isEdit = classId !== null; const classData = isEdit ? this.state.data.gymData.classes.find(c => c.id === classId) : {}; const startDate = isEdit ? new Date(classData.start) : new Date(); startDate.setMinutes(startDate.getMinutes() - startDate.getTimezoneOffset()); const dateValue = startDate.toISOString().split('T')[0]; const timeValue = startDate.toTimeString().substring(0, 5); const isProfessorRole = this.state.currentUser.role === 'professor'; const currentUserName = this.state.currentUser.name; let teacherInputHTML = ''; if (isProfessorRole) { teacherInputHTML = `<input id="swal-teacher" class="swal2-input" value="${currentUserName}" disabled>`; } else { const professors = Object.values(this.state.data.users).filter(u => u.role === 'professor').map(p => `<option value="${p.name}" ${isEdit && p.name === classData.teacher ? 'selected' : ''}>${p.name}</option>`).join(''); teacherInputHTML = `<select id="swal-teacher" class="swal2-select">${professors}</select>`; } const formHTML = `<style>#swal2-html-container { overflow: visible !important; }.swal-form-group { text-align: left; margin-bottom: 1rem; }.swal-form-group label { display: block; margin-bottom: .35rem; font-weight: 500; color: #545454; font-size: 0.85em; }body.dark-mode .swal-form-group label { color: #ccc; }.swal-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }.swal2-input, .swal2-select { width: 100% !important; margin: 0 !important; font-size: 0.9em !important; }</style><div class="swal-form-group"><label for="swal-title">T√≠tulo de la Clase</label><input id="swal-title" class="swal2-input" placeholder="Ej: Yoga Avanzado" value="${isEdit ? classData.title : ''}"></div><div class="swal-form-grid"><div class="swal-form-group"><label for="swal-date">Fecha</label><input id="swal-date" type="date" class="swal2-input" value="${dateValue}"></div><div class="swal-form-group"><label for="swal-time">Hora</label><input id="swal-time" type="time" class="swal2-input" value="${timeValue}"></div></div><div class="swal-form-grid"><div class="swal-form-group"><label for="swal-spots">Cupos Disponibles</label><input id="swal-spots" type="number" class="swal2-input" placeholder="Ej: 15" value="${isEdit ? classData.spots : ''}"></div><div class="swal-form-group"><label for="swal-teacher">Profesor</label>${teacherInputHTML}</div></div>`; Swal.fire({ title: isEdit ? 'Editar Clase' : 'Agendar Nueva Clase', html: formHTML, focusConfirm: false, showCancelButton: true, showDenyButton: isEdit, confirmButtonText: 'Guardar', cancelButtonText: 'Cancelar', denyButtonText: 'Eliminar', preConfirm: () => [ document.getElementById('swal-title').value, document.getElementById('swal-date').value, document.getElementById('swal-time').value, document.getElementById('swal-spots').value, document.getElementById('swal-teacher').value ] }).then(result => { if (result.isConfirmed) { this.handleSaveClass(isEdit ? classData.id : null, result.value); } else if (result.isDenied) { this.handleDeleteClass(classData.id); } }); },
            handleSaveClass(classId, values) { const [title, date, time, spots, teacher] = values; if (!title || !date || !time || !spots || !teacher) { this.showToast('Error', 'Todos los campos son obligatorios.', 'error'); return; } if (classId) { const classIndex = this.state.data.gymData.classes.findIndex(c => c.id === classId); if (classIndex > -1) { Object.assign(this.state.data.gymData.classes[classIndex], { title, start: `${date}T${time}:00`, spots: parseInt(spots), teacher }); this.showToast('Clase Actualizada', `La clase "${title}" se actualiz√≥.`); } } else { this.state.data.gymData.classes.push({ id: Date.now(), title, start: `${date}T${time}:00`, spots: parseInt(spots), teacher, reservedBy: [] }); this.showToast('Clase Creada', `La clase "${title}" ha sido agendada.`); } if(this.calendar) this.calendar.refetchEvents(); this.saveState(); },
            handleDeleteClass(classId) { Swal.fire({ title: '¬øConfirmar eliminaci√≥n?', text: "Esta acci√≥n no se puede deshacer.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠, eliminar', cancelButtonText: 'No, mantener' }).then(r => { if (r.isConfirmed) { this.state.data.gymData.classes = this.state.data.gymData.classes.filter(c => c.id !== classId); if(this.calendar) this.calendar.refetchEvents(); this.showToast('Clase Eliminada', 'La clase ha sido eliminada del calendario.', 'success'); this.saveState(); } }); },
            updateAdminAttendanceTable() { const tbody = document.getElementById('attendance-table-body'); if (!tbody) return; const logs = [...this.state.data.gymData.attendanceLog].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); const userMap = Object.values(this.state.data.users).reduce((acc, user) => { acc[user.id] = user.name; return acc; }, {}); tbody.innerHTML = logs.map(log => { const userName = userMap[log.memberId] || 'Socio Desconocido'; const logDate = new Date(log.timestamp); const date = logDate.toLocaleDateString('es-CL'); const time = logDate.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' }); return `<tr data-name="${userName.toLowerCase()}"><td>${userName}</td><td>${date}</td><td>${time}</td></tr>`; }).join(''); },
            
            showGoalSettingModal() {
                const user = this.state.currentUser;
                const goals = user.goals || {};
                const measurements = goals.measurements || {};
                document.getElementById('mainModalTitle').innerText = 'Definir Mis Objetivos';
                document.getElementById('mainModalBody').innerHTML = `
                    <form id="goalForm">
                        <p class="text-muted">Ingresa las metas que quieres alcanzar. Deja en blanco las que no quieras registrar.</p>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Objetivo de Peso (kg)</strong></label>
                                <input type="number" step="0.1" name="goalWeight" class="form-control" placeholder="Ej: 75" value="${goals.weight || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Objetivo de % Grasa Corporal</strong></label>
                                <input type="number" step="0.1" name="goalBodyFat" class="form-control" placeholder="Ej: 15" value="${goals.bodyFat || ''}">
                            </div>
                        </div>
                        <hr>
                        <h5>Medidas (cm)</h5>
                        <div class="row">
                             <div class="col-md-4 mb-3">
                                <label class="form-label">Pecho</label>
                                <input type="number" step="0.1" name="goalChest" class="form-control" value="${measurements.chest || ''}">
                            </div>
                             <div class="col-md-4 mb-3">
                                <label class="form-label">Cintura</label>
                                <input type="number" step="0.1" name="goalWaist" class="form-control" value="${measurements.waist || ''}">
                            </div>
                             <div class="col-md-4 mb-3">
                                <label class="form-label">Cadera</label>
                                <input type="number" step="0.1" name="goalHips" class="form-control" value="${measurements.hips || ''}">
                            </div>
                        </div>
                    </form>`;
                document.getElementById('mainModalFooter').innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="goalForm" class="btn btn-primary">Guardar Objetivos</button>`;
                document.getElementById('goalForm').onsubmit = (event) => this.handleGoalFormSubmit(event);
                this.mainModal.show();
            },
            handleGoalFormSubmit(event) {
                event.preventDefault();
                const form = event.target;
                const user = this.state.currentUser;
                user.goals = {
                    weight: form.elements.goalWeight.value ? parseFloat(form.elements.goalWeight.value) : null,
                    bodyFat: form.elements.goalBodyFat.value ? parseFloat(form.elements.goalBodyFat.value) : null,
                    measurements: {
                        chest: form.elements.goalChest.value ? parseFloat(form.elements.goalChest.value) : null,
                        waist: form.elements.goalWaist.value ? parseFloat(form.elements.goalWaist.value) : null,
                        hips: form.elements.goalHips.value ? parseFloat(form.elements.goalHips.value) : null,
                    }
                };
                this.saveState();
                this.mainModal.hide();
                this.showToast('¬°√âxito!', 'Tus objetivos han sido guardados.', 'success');
                this.updateStudentGoalsUI();
            },
            updateStudentGoalsUI() {
                const container = document.getElementById('goal-progress-container');
                if (!container) return;
                const user = this.state.currentUser;
                const goals = user.goals || {};
                const progressData = user.progress;
                let contentHTML = '';

                const goalDefinitions = [
                    { key: 'weight', title: 'Objetivo de Peso', icon: 'fa-weight', unit: 'kg', data: progressData.weights, color: 'primary' },
                    { key: 'bodyFat', title: 'Objetivo de % Grasa', icon: 'fa-percentage', unit: '%', data: progressData.bodyFat, color: 'danger' },
                    { key: 'chest', parent: 'measurements', title: 'Objetivo de Pecho', icon: 'fa-ruler-combined', unit: 'cm', data: progressData.measurements.chest, color: 'success' },
                    { key: 'waist', parent: 'measurements', title: 'Objetivo de Cintura', icon: 'fa-ruler-combined', unit: 'cm', data: progressData.measurements.waist, color: 'warning' },
                    { key: 'hips', parent: 'measurements', title: 'Objetivo de Cadera', icon: 'fa-ruler-combined', unit: 'cm', data: progressData.measurements.hips, color: 'info' }
                ];

                goalDefinitions.forEach(def => {
                    const goalValue = def.parent ? (goals.measurements && goals.measurements[def.key]) : goals[def.key];
                    if (goalValue && def.data && def.data.length > 0) {
                        const startValue = def.data[0];
                        const currentValue = def.data[def.data.length - 1];
                        const totalDistance = Math.abs(startValue - goalValue);
                        const travelledDistance = Math.abs(startValue - currentValue);
                        let percentage = totalDistance > 0 ? (travelledDistance / totalDistance) * 100 : 0;
                        
                        let isAchieved = false;
                        if (goalValue > startValue) { 
                            if (currentValue >= goalValue) isAchieved = true;
                        } else { 
                            if (currentValue <= goalValue) isAchieved = true;
                        }
                        
                        if (isAchieved) percentage = 100;
                        percentage = Math.max(0, Math.min(100, percentage));
                        
                        const remaining = Math.abs(currentValue - goalValue).toFixed(1);

                        contentHTML += `
                            <div class="col-lg-4 col-md-6">
                                <div class="goal-card">
                                    <div class="goal-card-header">
                                        <div class="goal-card-icon"><i class="fas ${def.icon}"></i></div>
                                        <div><h6 class="mb-0">${def.title}</h6><small class="text-muted">Actual: ${currentValue}${def.unit} / Meta: ${goalValue}${def.unit}</small></div>
                                    </div>
                                    <div class="progress mb-2"><div class="progress-bar progress-bar-striped progress-bar-animated bg-${def.color}" role="progressbar" style="width: ${percentage}%" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div></div>
                                    <div class="text-center mt-auto">
                                        ${isAchieved ? `<strong class="text-success"><i class="fas fa-check-circle me-1"></i>¬°Objetivo Logrado!</strong>` : `<small class="text-muted">Te faltan ${remaining}${def.unit} para alcanzar tu meta.</small>`}
                                    </div>
                                </div>
                            </div>`;
                    }
                });

                if (contentHTML === '') {
                    container.innerHTML = `<div class="col-12 text-center text-muted p-4"><i class="fas fa-bullseye fa-2x mb-2"></i><p>A√∫n no has definido tus objetivos. ¬°Haz clic en el bot√≥n de arriba para empezar!</p></div>`;
                } else {
                    container.innerHTML = contentHTML;
                }
            },
            getHealthRecommendations() {
                const progress = this.state.currentUser.progress;
                if (!progress || !progress.bodyFat || progress.bodyFat.length === 0) {
                    return '';
                }

                const currentFat = progress.bodyFat[progress.bodyFat.length - 1];
                let category, advice, icon, color;

                if (currentFat < 14) {
                    category = "Nivel Atl√©tico/Bajo en Grasa";
                    icon = "fa-trophy";
                    color = "info";
                    advice = [ "Tu nivel de grasa es excelente. El enfoque debe ser mantener y optimizar el rendimiento.", "Asegura una ingesta cal√≥rica adecuada para soportar tus entrenamientos y recuperaci√≥n.", "Prioriza el entrenamiento de fuerza para mantener o aumentar la masa muscular." ];
                } else if (currentFat >= 14 && currentFat <= 20) {
                    category = "Nivel Fitness/Saludable";
                    icon = "fa-heart-pulse";
                    color = "success";
                    advice = [ "Est√°s en un rango saludable y en forma. ¬°Gran trabajo!", "Para mejorar, combina entrenamiento de fuerza (3-4 d√≠as/sem) con cardio moderado (2-3 d√≠as/sem).", "Mant√©n una dieta balanceada rica en prote√≠nas para favorecer la ganancia muscular." ];
                } else if (currentFat > 20 && currentFat <= 25) {
                    category = "Nivel Promedio/Aceptable";
                    icon = "fa-person-running";
                    color = "warning";
                    advice = [ "Tienes una base ideal para mejorar tu composici√≥n corporal.", "Incrementa la actividad cardiovascular a 3-4 sesiones por semana.", "No descuides el entrenamiento de fuerza. Construir m√∫sculo acelerar√° tu metabolismo." ];
                } else {
                    category = "Oportunidad de Mejora";
                    icon = "fa-bullseye";
                    color = "danger";
                    advice = [ "El enfoque principal debe ser la reducci√≥n de grasa para mejorar la salud.", "Crea un d√©ficit cal√≥rico moderado a trav√©s de la dieta.", "Realiza ejercicio cardiovascular de 4 a 5 d√≠as por semana." ];
                }

                const adviceHTML = advice.map(item => `<li>${item}</li>`).join('');

                return `
                <div class="card mb-4 recommendation-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-3 mb-3">
                            <div class="icon-circle bg-${color}-subtle text-${color}-emphasis"> <i class="fas ${icon}"></i> </div>
                            <div>
                                <h5 class="card-title mb-0">Recomendaciones Personalizadas</h5>
                                <p class="card-text text-muted mb-0">Basado en tu <strong>${currentFat}%</strong> de grasa corporal (Categor√≠a: ${category})</p>
                            </div>
                        </div>
                        <ul>${adviceHTML}</ul>
                    </div>
                </div>`;
            },
            updateFacilitiesTable() {
                const grid = document.getElementById('facilities-grid');
                if (!grid) return;
                
                const equipmentList = this.state.data.gymData.equipment;
                
                const statusInfo = { 'Operativo': { class: 'status-operativo', textClass: 'text-success', icon: 'fa-check-circle' }, 'En Mantenimiento': { class: 'status-mantenimiento', textClass: 'text-warning', icon: 'fa-tools' }, 'Averiado': { class: 'status-averiado', textClass: 'text-danger', icon: 'fa-exclamation-triangle' } };
                const typeIcons = { 'Cardio': 'fa-heart-pulse', 'Fuerza': 'fa-dumbbell', 'Funcional': 'fa-running', 'Accesorios': 'fa-puzzle-piece' };

                if (equipmentList.length === 0) { grid.innerHTML = `<div class="col-12 text-center text-muted p-5"><p>No hay equipos registrados.</p></div>`; return; }

                grid.innerHTML = equipmentList.map(item => {
                    const status = statusInfo[item.status] || { class: '', textClass: '', icon: 'fa-question-circle' };
                    const lastMaint = item.lastMaintenance ? new Date(item.lastMaintenance).toLocaleDateString('es-CL') : 'N/A';
                    const nextMaint = item.nextMaintenance ? new Date(item.nextMaintenance).toLocaleDateString('es-CL') : 'N/A';
                    
                    return `
                    <div class="card equipment-card ${status.class}" data-name="${item.name.toLowerCase()}">
                        <div class="card-header">
                            <h5 class="card-title">${item.name}</h5>
                            <i class="fas ${typeIcons[item.type] || 'fa-cog'} type-icon" title="${item.type}"></i>
                        </div>
                        <div class="card-body">
                            <ul class="details-list">
                                <li>
                                    <span class="icon"><i class="fas fa-info-circle"></i></span>
                                    <strong>Estado</strong>
                                    <span class="badge ${status.class.replace('status-', 'bg-')}-subtle ${status.textClass}-emphasis rounded-pill">${item.status}</span>
                                </li>
                                <li>
                                    <span class="icon"><i class="fas fa-calendar-alt"></i></span>
                                    <strong>√öltimo Mant.</strong>
                                    <span>${lastMaint}</span>
                                </li>
                                <li>
                                    <span class="icon"><i class="fas fa-calendar-check"></i></span>
                                    <strong>Pr√≥ximo Mant.</strong>
                                    <span>${nextMaint}</span>
                                </li>
                                <li>
                                    <span class="icon"><i class="fas fa-user-cog"></i></span>
                                    <strong>T√©cnico</strong>
                                    <span>${item.technician || 'N/A'}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="card-footer d-grid">
                             <button class="btn btn-sm btn-outline-primary" onclick="GymApp.showEquipmentFormModal(${item.id})">
                                <i class="fas fa-edit me-1"></i> Editar
                            </button>
                        </div>
                    </div>`;
                }).join('');
            },
            showEquipmentFormModal(equipmentId = null) {
                const isEdit = equipmentId !== null;
                const item = isEdit ? this.state.data.gymData.equipment.find(e => e.id === equipmentId) : {};
                
                document.getElementById('mainModalTitle').innerText = isEdit ? `Editar Equipo: ${item.name}` : 'A√±adir Nuevo Equipo';
                document.getElementById('mainModalBody').innerHTML = `
                    <form id="equipmentForm">
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Nombre del Equipo</label>
                                <input type="text" name="name" class="form-control" value="${item.name || ''}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Tipo</label>
                                <select name="type" class="form-select" required>
                                    <option ${!item.type ? 'selected' : ''} disabled value="">Seleccionar...</option>
                                    <option value="Cardio" ${item.type === 'Cardio' ? 'selected' : ''}>Cardio</option>
                                    <option value="Fuerza" ${item.type === 'Fuerza' ? 'selected' : ''}>Fuerza</option>
                                    <option value="Funcional" ${item.type === 'Funcional' ? 'selected' : ''}>Funcional</option>
                                    <option value="Accesorios" ${item.type === 'Accesorios' ? 'selected' : ''}>Accesorios</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                             <div class="col-md-6 mb-3">
                                <label class="form-label">Estado</label>
                                <select name="status" class="form-select" required>
                                    <option value="Operativo" ${item.status === 'Operativo' ? 'selected' : ''}>Operativo</option>
                                    <option value="En Mantenimiento" ${item.status === 'En Mantenimiento' ? 'selected' : ''}>En Mantenimiento</option>
                                    <option value="Averiado" ${item.status === 'Averiado' ? 'selected' : ''}>Averiado</option>
                                </select>
                            </div>
                             <div class="col-md-6 mb-3">
                                <label class="form-label">T√©cnico Asignado</label>
                                <input type="text" name="technician" class="form-control" value="${item.technician || ''}">
                            </div>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha √öltimo Mantenimiento</label>
                                <input type="date" name="lastMaintenance" class="form-control" value="${item.lastMaintenance || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Pr√≥ximo Mantenimiento</label>
                                <input type="date" name="nextMaintenance" class="form-control" value="${item.nextMaintenance || ''}">
                            </div>
                        </div>
                        <div class="mb-3">
                             <label class="form-label">Notas Adicionales</label>
                             <textarea name="notes" class="form-control" rows="3">${item.notes || ''}</textarea>
                        </div>
                    </form>
                `;
                document.getElementById('mainModalFooter').innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="equipmentForm" class="btn btn-primary">Guardar</button>`;
                document.getElementById('equipmentForm').onsubmit = (event) => this.handleEquipmentFormSubmit(event, equipmentId);
                this.mainModal.show();
            },
            handleEquipmentFormSubmit(event, equipmentId = null) {
                event.preventDefault();
                const form = event.target;
                const formData = {
                    name: form.elements.name.value,
                    type: form.elements.type.value,
                    status: form.elements.status.value,
                    lastMaintenance: form.elements.lastMaintenance.value,
                    nextMaintenance: form.elements.nextMaintenance.value,
                    technician: form.elements.technician.value,
                    notes: form.elements.notes.value,
                };

                if (equipmentId) {
                    const itemIndex = this.state.data.gymData.equipment.findIndex(e => e.id === equipmentId);
                    if (itemIndex > -1) {
                        this.state.data.gymData.equipment[itemIndex] = { ...this.state.data.gymData.equipment[itemIndex], ...formData };
                        this.showToast('√âxito', 'Equipo actualizado.', 'success');
                    }
                } else {
                    const newItem = { id: Date.now(), ...formData };
                    this.state.data.gymData.equipment.push(newItem);
                    this.showToast('√âxito', 'Nuevo equipo registrado.', 'success');
                }
                
                this.saveState();
                this.mainModal.hide();
                this.updateFacilitiesTable();
            },
            renderExerciseLibrary() {
                const muscleGroups = ['Todos', ...new Set(this.state.data.gymData.exerciseLibrary.map(ex => ex.muscleGroup))];
                const equipments = ['Todos', ...new Set(this.state.data.gymData.exerciseLibrary.map(ex => ex.equipment))];

                const muscleFilter = document.getElementById('muscle-group-filter');
                muscleFilter.innerHTML = muscleGroups.map(g => `<option value="${g}">${g}</option>`).join('');
                muscleFilter.onchange = () => this.filterAndRenderExercises();

                const equipmentFilter = document.getElementById('equipment-filter');
                equipmentFilter.innerHTML = equipments.map(e => `<option value="${e}">${e}</option>`).join('');
                equipmentFilter.onchange = () => this.filterAndRenderExercises();

                document.getElementById('exercise-search').onkeyup = () => this.filterAndRenderExercises();

                this.filterAndRenderExercises();
            },

            filterAndRenderExercises() {
                const container = document.getElementById('exercise-cards-container');
                const searchTerm = document.getElementById('exercise-search').value.toLowerCase();
                const selectedGroup = document.getElementById('muscle-group-filter').value;
                const selectedEquipment = document.getElementById('equipment-filter').value;
                
                const filteredExercises = this.state.data.gymData.exerciseLibrary.filter(ex => {
                    const nameMatch = ex.name.toLowerCase().includes(searchTerm);
                    const groupMatch = selectedGroup === 'Todos' || ex.muscleGroup === selectedGroup;
                    const equipmentMatch = selectedEquipment === 'Todos' || ex.equipment === selectedEquipment;
                    return nameMatch && groupMatch && equipmentMatch;
                });

                if (filteredExercises.length === 0) {
                    container.innerHTML = `<div class="col-12 w-100 text-center text-muted mt-4"><i class="fas fa-search fa-3x mb-3"></i><h4>No se encontraron ejercicios</h4><p>Intenta ajustar los filtros de b√∫squeda.</p></div>`;
                    return;
                }

                container.innerHTML = filteredExercises.map(ex => `
                    <div class="card exercise-card" onclick="GymApp.showExerciseDetailsModal(${ex.id})">
                        <div class="card-body">
                            <h5 class="card-title">${ex.name}</h5>
                        </div>
                        <div class="card-footer d-flex gap-2">
                            <span class="badge bg-primary-subtle text-primary-emphasis">${ex.muscleGroup}</span>
                            <span class="badge bg-info-subtle text-info-emphasis">${ex.equipment}</span>
                        </div>
                    </div>
                `).join('');
            },

            resetExerciseFilters() {
                document.getElementById('exercise-search').value = '';
                document.getElementById('muscle-group-filter').value = 'Todos';
                document.getElementById('equipment-filter').value = 'Todos';
                this.filterAndRenderExercises();
            },
            
            showExerciseDetailsModal(exerciseId) {
                const ex = this.state.data.gymData.exerciseLibrary.find(e => e.id === exerciseId);
                if (!ex) return;

                const videoHTML = ex.videoUrl 
                    ? `<div class="exercise-video-wrapper mb-4"><iframe src="${ex.videoUrl.replace('watch?v=', 'embed/')}" frameborder="0" allowfullscreen></iframe></div>` 
                    : '<p class="text-muted text-center mb-4">(Video no disponible)</p>';
                
                const instructionsHTML = ex.instructions && ex.instructions.length > 0 
                    ? `<ol>${ex.instructions.map(step => `<li>${step}</li>`).join('')}</ol>`
                    : '<p class="text-muted">No hay instrucciones detalladas.</p>';

                const tipsHTML = ex.tips
                    ? `<div class="mt-3 p-3 rounded" style="background-color: var(--primary-light);"><i class="fas fa-lightbulb me-2 text-primary"></i>${ex.tips}</div>`
                    : '';

                document.getElementById('mainModalTitle').innerText = ex.name;
                document.getElementById('mainModalBody').innerHTML = `
                    ${videoHTML}
                    <h5 class="mt-4"><i class="fas fa-list-ol me-2"></i>Instrucciones</h5>
                    ${instructionsHTML}
                    <h5 class="mt-4"><i class="fas fa-star me-2"></i>Consejos</h5>
                    ${tipsHTML}
                `;
                document.getElementById('mainModalFooter').innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>`;
                this.mainModal.show();
            },

            showExerciseFormModal(exerciseId = null) {
                const isEdit = exerciseId !== null;
                const exercise = isEdit ? this.state.data.gymData.exerciseLibrary.find(e => e.id === exerciseId) : {};
                
                document.getElementById('mainModalTitle').innerText = isEdit ? `Editar Ejercicio: ${exercise.name}` : 'A√±adir Nuevo Ejercicio';
                document.getElementById('mainModalBody').innerHTML = `
                    <form id="libExerciseForm">
                        <div class="mb-3"><label class="form-label">Nombre del Ejercicio</label><input type="text" name="name" class="form-control" value="${exercise.name || ''}" required></div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Grupo Muscular</label><input type="text" name="muscleGroup" class="form-control" value="${exercise.muscleGroup || ''}" placeholder="Ej: Pecho, Piernas" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Equipamiento</label><input type="text" name="equipment" class="form-control" value="${exercise.equipment || ''}" placeholder="Ej: Barra, Peso Corporal" required></div>
                        </div>
                        <div class="mb-3"><label class="form-label">URL del Video (YouTube)</label><input type="url" name="videoUrl" class="form-control" value="${exercise.videoUrl || ''}" placeholder="https://www.youtube.com/watch?v=..."></div>
                        <div class="mb-3"><label class="form-label">Instrucciones (una por l√≠nea)</label><textarea name="instructions" class="form-control" rows="5">${(exercise.instructions || []).join('\n')}</textarea></div>
                        <div class="mb-3"><label class="form-label">Consejos</label><textarea name="tips" class="form-control" rows="2">${exercise.tips || ''}</textarea></div>
                    </form>`;
                document.getElementById('mainModalFooter').innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="libExerciseForm" class="btn btn-primary">Guardar</button>`;
                document.getElementById('libExerciseForm').onsubmit = (event) => this.handleLibExerciseFormSubmit(event, exerciseId);
                this.mainModal.show();
            },
            handleLibExerciseFormSubmit(event, exerciseId = null) {
                event.preventDefault();
                const form = event.target;
                const formData = {
                    name: form.elements.name.value,
                    muscleGroup: form.elements.muscleGroup.value,
                    equipment: form.elements.equipment.value,
                    videoUrl: form.elements.videoUrl.value,
                    instructions: form.elements.instructions.value.split('\n').filter(line => line.trim() !== ''),
                    tips: form.elements.tips.value,
                };

                if (exerciseId) {
                    const index = this.state.data.gymData.exerciseLibrary.findIndex(e => e.id === exerciseId);
                    if (index > -1) {
                        this.state.data.gymData.exerciseLibrary[index] = { ...this.state.data.gymData.exerciseLibrary[index], ...formData };
                        this.showToast('√âxito', 'Ejercicio actualizado.', 'success');
                    }
                } else {
                    const newId = Date.now();
                    this.state.data.gymData.exerciseLibrary.push({ id: newId, ...formData });
                    this.showToast('√âxito', 'Nuevo ejercicio a√±adido.', 'success');
                }
                
                this.saveState();
                this.mainModal.hide();
                this.renderExerciseLibrary();
            },
            deleteExerciseFromLibrary(exerciseId) {
                Swal.fire({title:'¬øEliminar de la biblioteca?',text:"Esta acci√≥n no se puede deshacer.",icon:'warning',showCancelButton:true,confirmButtonColor:'#d33',confirmButtonText:'S√≠, eliminar'}).then(r => {
                    if (r.isConfirmed) {
                        this.state.data.gymData.exerciseLibrary = this.state.data.gymData.exerciseLibrary.filter(e => e.id !== exerciseId);
                        this.saveState();
                        this.showToast('Eliminado', 'El ejercicio ha sido eliminado.', 'success');
                        this.renderExerciseLibrary();
                    }
                });
            }
        });

        document.addEventListener('DOMContentLoaded', () => GymApp.init());
    </script>
</body>
</html>